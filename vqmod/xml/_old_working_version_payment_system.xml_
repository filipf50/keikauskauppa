<modification>
	<id>Payment System</id>
	<version>20140101</version>
	<vqmver>2.4.1</vqmver>
	<author>Digital Web Depot</author>
	
	<file name="admin/controller/catalog/product.php">
		<operation>
			<search position="before"><![CDATA[
				$this->data['tab_general'] = $this->language->get('tab_general');
			]]></search>
			<add><![CDATA[
				$this->data['entry_payment_due'] = $this->language->get('entry_payment_due');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				if (isset($this->request->post['model'])) {
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['payment_due'])) {
					$this->data['payment_due'] = $this->request->post['payment_due'];
				} elseif (!empty($product_info) && !empty($product_info['payment_due'])) {
					$this->data['payment_due'] = date('Y-m-d', $product_info['payment_due']);
				} else {
					$this->data['payment_due'] = '';
				}
			]]></add>
		</operation>
	</file>

	<file name="admin/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
				$this->data['title'] = $this->document->getTitle(); 
			]]></search>
			<add><![CDATA[
				$this->db->query("CREATE TABLE IF NOT EXISTS " . DB_PREFIX . "order_layaway (
					`layaway_id` INT(11) NOT NULL auto_increment,
					`customer_id` INT(11) NOT NULL DEFAULT 0,
					`order_id` INT(11) NOT NULL UNIQUE,
					`deposit` DECIMAL(15,4) NOT NULL DEFAULT 0.0000,
					`payments` mediumtext COLLATE utf8_bin NOT NULL DEFAULT '',
					`date_added` INT(11) NOT NULL DEFAULT 0,
					`paid_in_full` TINYINT(1) NOT NULL DEFAULT 0,
					`email_sent` TINYINT(1) NOT NULL DEFAULT 0,
					PRIMARY KEY (layaway_id));
				");
				$results = $this->db->query("SHOW COLUMNS FROM `" . DB_PREFIX . "product` LIKE 'payment_due'");
				if ($results->num_rows < 1) {
					$this->db->query("ALTER TABLE `" . DB_PREFIX . "product` ADD COLUMN payment_due int(11) NOT NULL");
				}
				$results = $this->db->query("SHOW COLUMNS FROM `" . DB_PREFIX . "order` LIKE 'layaway_deposit'");
				if ($results->num_rows < 1) {
					$this->db->query("ALTER TABLE `" . DB_PREFIX . "order` ADD COLUMN layaway_deposit decimal(15,4) NOT NULL DEFAULT 0.0000");
				}
				$results = $this->db->query("SHOW COLUMNS FROM " . DB_PREFIX . "order_layaway LIKE 'paid_in_full'");
				if (!$results->num_rows) {
					$this->db->query("ALTER TABLE " . DB_PREFIX . "order_layaway ADD COLUMN paid_in_full TINYINT(1) NOT NULL DEFAULT 0");
					$this->db->query("ALTER TABLE " . DB_PREFIX . "order_layaway ADD COLUMN email_sent TINYINT(1) NOT NULL DEFAULT 0");
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway");
					if ($query->num_rows) {
						foreach ($query->rows as $row) {
							$records = unserialize($row['payments']);
							if (!empty($records)) {
								$order_total = $this->db->query("SELECT total FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$row['order_id'] . "'");
								$amount_paid = $row['deposit'];
								foreach ($records as $record) {
									$amount_paid += $record['payment_amount'];
								}
								if (round($order_total->row['total'],2) == $amount_paid) {
									$this->db->query("UPDATE " . DB_PREFIX . "order_layaway SET paid_in_full = 1 WHERE layaway_id = '" . (int)$row['layaway_id'] . "' AND order_id = '" . (int)$row['order_id'] . "'");
								}
							}
						}
					}
				}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/controller/common/home.php">
		<operation>
			<search position="before"><![CDATA[
				$this->data['orders'][] = array(
			]]></search>
			<add><![CDATA[
				$layaways = $this->model_sale_order->getLayaway($result['order_id']);
				if ($layaways) {
					foreach ($layaways as $layaway) {
						$balance = $result['total'] - $layaway['deposit'];
						if (!empty($layaway['payments'])) {
							foreach (unserialize($layaway['payments']) as $payment) {
								$balance -= $payment['payment_amount'];
							}
						}
					}
					if (number_format($balance, 2, ".", "") > 0) {
						$this->data['color'][$result['order_id']] = "#2755bb";
					}
				}
			]]></add>
		</operation>
	</file>

	<file name="admin/controller/extension/payment.php">
		<operation>
			<search position="before"><![CDATA[
				$this->data['extensions'][] = array(
			]]></search>
			<add><![CDATA[
				$status = $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled');
				if ($this->config->get('layaway_allow_deposit') && $extension == "layaway") {
					$status = $this->language->get('text_enabled');
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'status'     => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
			]]></search>
			<add><![CDATA[
				'status'     => $status,
			]]></add>
		</operation>
	</file>
	
	<file name="admin/controller/sale/order.php">
		<operation>
			<search position="before" index="1"><![CDATA[
				$this->data['orders'][] = array(
			]]></search>
			<add><![CDATA[
				$layaways = $this->model_sale_order->getLayaway($result['order_id']);
				$layaway_deposit = 0;
				if (!empty($layaways)) {
					$balance = $result['total'];
					foreach ($layaways as $layaway) {
						$balance -= $layaway['deposit'];
						$layaway_deposit = $layaway['deposit'];
						if (!empty($layaway['payments'])) {
							foreach (unserialize($layaway['payments']) as $payment) {
								$balance -= $payment['payment_amount'];
							}
						}
					}
					if (number_format($balance, 2, ".", "") > 0) {
						$this->data['color'][$result['order_id']] = "#2755bb";
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				'selected'      => isset($this->request->post['selected']) && in_array($result['order_id'], $this->request->post['selected']),
			]]></search>
			<add><![CDATA[
				'layaway'		 => $this->currency->format($layaway_deposit, $result['currency_code'], $result['currency_value']),
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				$this->data['tab_order_history'] = $this->language->get('tab_order_history');
			]]></search>
			<add><![CDATA[
				$this->data['tab_layaway'] = sprintf($this->language->get('tab_layaway'), $this->config->get('layaway_button_name'));
				$this->data['button_save'] = $this->language->get('button_save');
				$this->data['button_add_layaway'] = $this->language->get('button_add_layaway');
				$this->data['entry_amount'] = $this->language->get('entry_amount');
				$this->data['entry_description'] = $this->language->get('entry_description');
				$this->data['text_paid'] = $this->language->get('text_paid');
				$this->data['text_balance'] = sprintf($this->language->get('text_balance'), $this->config->get('layaway_button_name'));
				$this->data['text_apply_payment'] = sprintf($this->language->get('text_apply_payment'), strtoupper($this->config->get('layaway_button_name')));
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				$this->data['tab_fraud'] = $this->language->get('tab_fraud');
			]]></search>
			<add><![CDATA[
				$this->data['tab_layaway'] = sprintf($this->language->get('tab_layaway'), $this->config->get('layaway_button_name'));
				$this->data['button_save'] = $this->language->get('button_save');
				$this->data['button_add_layaway'] = $this->language->get('button_add_layaway');
				$this->data['entry_amount'] = $this->language->get('entry_amount');
				$this->data['entry_description'] = $this->language->get('entry_description');
				$this->data['text_paid'] = $this->language->get('text_paid');
				$this->data['text_balance'] = sprintf($this->language->get('text_balance'), $this->config->get('layaway_button_name'));
				$this->data['text_apply_payment'] = sprintf($this->language->get('text_apply_payment'), strtoupper($this->config->get('layaway_button_name')));
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->data['lastname'] = $order_info['lastname'];
			]]></search>
			<add><![CDATA[
				$this->data['customer_id'] = $order_info['customer_id'];
				$this->data['active_layaway'] = 0;
				$layaways = $this->model_sale_order->getLayaway($this->request->get['order_id']);
				if ($layaways) {
					$this->data['active_layaway'] = 1;
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->data['customer'] = '';
			]]></search>
			<add><![CDATA[
				$this->data['customer_id'] = '';
			]]></add>
		</operation>
		<operation>
			<search position="after" index="2"><![CDATA[
				$order_info = $this->model_sale_order->getOrder($order_id);
			]]></search>
			<add><![CDATA[
				$layaway_deposit = 0;
				$layaway_balance = 0;
				if ($order_info['layaway_deposit'] > 0) {
					$this->data['text_layaway_deposit'] = sprintf($this->language->get('text_layaway_deposit'), $this->config->get('layaway_button_name'));
					$this->data['text_layaway_balance'] = sprintf($this->language->get('text_layaway_balance'), $this->config->get('layaway_button_name'));
					$layaway_deposit = $this->currency->format($order_info['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value']);
					$layaway_balance = $this->currency->format($order_info['total'] - $order_info['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value']);
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				'payment_method'     => $order_info['payment_method'],
			]]></search>
			<add><![CDATA[
				'layaway_deposit'    => $layaway_deposit,
				'layaway_balance'	 => $layaway_balance,
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				'payment_address'  => $payment_address,
			]]></search>
			<add><![CDATA[
				'layaway_deposit'    => $layaway_deposit,
				'layaway_balance'	 => $layaway_balance,
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				public function createInvoiceNo() {
			]]></search>
			<add><![CDATA[
				public function layaway() {
					$this->language->load('sale/customer');
					$this->language->load('sale/order');
					$this->load->model('sale/order');
					if (($this->request->server['REQUEST_METHOD'] == 'POST') && $this->user->hasPermission('modify', 'sale/order')) { 
						$this->model_sale_order->updateLayaway($this->request->post['description'], $this->request->post['amount'], $this->request->get['order_id']);
						$this->data['success'] = $this->language->get('text_credit_added');
					} else {
						$this->data['success'] = '';
					}
					if (($this->request->server['REQUEST_METHOD'] == 'POST') && !$this->user->hasPermission('modify', 'sale/order')) {
						$this->data['error_warning'] = $this->language->get('error_permission');
					} else {
						$this->data['error_warning'] = '';
					}
					$this->data['text_no_results'] = $this->language->get('text_no_results');
					$this->data['text_balance'] = sprintf($this->language->get('text_balance'), $this->config->get('layaway_button_name'));
					$this->data['text_paid'] = $this->language->get('text_paid');
					$this->data['column_date_added'] = $this->language->get('column_date_added');
					$this->data['column_description'] = $this->language->get('column_description');
					$this->data['column_amount'] = $this->language->get('column_amount');
					$this->data['column_balance'] = $this->language->get('column_balance');
					$order_info = $this->model_sale_order->getOrder($this->request->get['order_id']);
					$this->data['layaways'] = array();
					$this->data['paid'] = 0;
					$this->data['balance'] = 0;
					$this->load->model('sale/order');
					$results = $this->model_sale_order->getLayaway($this->request->get['order_id']);
					foreach ($results as $result) {
						$paid = $result['deposit'];
						$balance = $order_info['total'] - $paid;
						$this->data['layaways'][] = array(
							'amount'      => $this->currency->format($result['deposit'], $this->config->get('config_currency')),
							'description' => $this->config->get('layaway_button_name') . " Deposit",
							'date_added'  => date($this->language->get('date_format_short'), $result['date_added'])
						);
						if (!empty($result['payments'])) {
							foreach (unserialize($result['payments']) as $payment) {
								$paid += $payment['payment_amount'];
								$balance -= $payment['payment_amount'];
								$this->data['layaways'][] = array(
									'amount'		=> $this->currency->format($payment['payment_amount'], $this->config->get('config_currency')),
									'description'	=> $this->config->get('layaway_button_name') . " Payment",
									'date_added'	=> date($this->language->get('date_format_short'), $payment['payment_date'])
								);
							}
						}
						$this->data['paid'] = $this->currency->format($paid, $this->config->get('config_currency'));
						$this->data['balance'] = $this->currency->format($balance, $this->config->get('config_currency'));
					}
					$this->template = 'sale/order_layaway.tpl';		
					$this->response->setOutput($this->render());
				}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/controller/sale/order_entry.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				if ($order_status_id == $this->config->get('config_quote_order_status') || $result['payment_code'] == "pending" || ($result['payment_code'] == "pp_link" && $result['order_paid'] ==0) || ($result['payment_code'] == "invoice" && $result['order_paid'] == 0) || ($result['payment_code'] == "purchase_order" && $result['order_paid'] == 0)) {
			]]></search>
			<add><![CDATA[
				if ($order_status_id == $this->config->get('config_quote_order_status') || $result['payment_code'] == "pending" || ($result['payment_code'] == "pp_link" && $result['order_paid'] ==0) || ($result['payment_code'] == "invoice" && $result['order_paid'] == 0) || ($result['payment_code'] == "purchase_order" && $result['order_paid'] == 0) || ($result['payment_code'] == "pp_standard" && $result['order_paid'] == 0 && (isset($result['layaway_deposit']) && $result['layaway_deposit'] <= 0))) {
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
				$store_name = $this->config->get('config_name');
			]]></search>
			<add><![CDATA[
				$layaways = $this->model_sale_order->getLayaway($result['order_id']);
				if ($layaways) {
					foreach ($layaways as $layaway) {
						if ($layaway['paid_in_full'] == 0) {
							$balance = $this->currency->format($result['total'] - $layaway['deposit'], $this->session->data['selected_currency']['code'], $this->session->data['selected_currency']['value'], false);
							if (!empty($layaway['payments'])) {
								foreach (unserialize($layaway['payments']) as $payment) {
									$balance -= $payment['payment_amount'];
								}
							}
						}
					}
					if ($balance > 0) {
						$layaway_plan = true;
					}
					$payment_method = $result['payment_method'];
				}
			]]></add>
		</operation>
	</file>

	<file name="admin/language/*/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['entry_payment_due']			= 'Pay By Date:<span class="help">Product must be paid for by this date</span>';
			]]></add>
		</operation>
	</file>

	<file name="admin/language/*/mail/order.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['text_layaway_subject']  	= '%s - %s Account Payment Approval';
				$_['text_layaway_received'] 	= 'Your %s Payment has been received and approved. The payment amount is: %s';
				$_['text_layaway_total']    	= 'Please login to your account to view %s balances and transactions.';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/language/*/sale/order.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['column_balance']                          = '<font color="2755bb"><b>%s Balance </b></font>';
				$_['entry_description']     				  = 'Payment Description:';
				$_['entry_amount']                            = 'Payment Amount:';
				$_['tab_layaway']							  = '%s Transactions';
				$_['text_layaway']							  = '%s';
				$_['text_paid']                               = '<font color="2755bb"><b>Total Paid to Date: </b></font>';
				$_['text_balance']                            = '<font color="2755bb"><b>%s Outstanding Balance: </b></font>';
				$_['text_apply_payment']					  = 'APPLY %s PAYMENT';
				$_['text_layaway_deposit']					  = '%s Deposit';
				$_['text_layaway_balance']					  = '%s Balance';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
				model = '" . $this->db->escape($data['model']) . "',
			]]></search>
			<add><![CDATA[
				model = '" . $this->db->escape($data['model']) . "', payment_due = '" . strtotime($data['payment_due']) . "',
			]]></add>
		</operation>
	</file>

	<file name="admin/model/sale/order.php">
		<operation error="skip">
			<search position="replace"><![CDATA[
				currency_value = '" . (float)$currency_value . "',
			]]></search>
			<add><![CDATA[
				currency_value = '" . (float)$currency_value . "', layaway_deposit = '" . (float)$data['layaway_deposit'] . "',
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				$order_id = $this->db->getLastId();
			]]></search>
			<add><![CDATA[
				if (isset($data['layaway_deposit']) && $data['layaway_deposit'] > 0) {
					$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$this->config->get('layaway_order_status_id') . "'");
					$date = time();
					$this->db->query("INSERT INTO " . DB_PREFIX . "order_layaway SET customer_id = '" . (int)$data['customer_id'] . "', order_id = '" . (int)$order_id . "', deposit = '" . (float)$data['layaway_deposit'] . "', date_added = '" . $date . "'");
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				'date_modified'           => $order_query->row['date_modified']
			]]></search>
			<add><![CDATA[
				'layaway_deposit'         => $order_query->row['layaway_deposit'],
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				public function createInvoiceNo($order_id) {
			]]></search>
			<add><![CDATA[
				public function getLayaway($order_id) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . $order_id . "'");
					return $query->rows;
				}
				
				public function getTotalLayawaysByOrderId($order_id) {
					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					return $query->row['total'];
				}

				public function getLayawayTotalByOrderId($order_id) {
					$query = $this->db->query("SELECT SUM(amount) AS total FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					return $query->row['total'];
				}

				public function updateLayaway($description, $amount, $order_id) {
					$this->load->language('mail/order');
					$order_info = $this->getOrder($order_id);
					$add_payment = array();
					$balance = round($order_info['total'],2);
					$layaway = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					if ($layaway) {
						foreach ($layaway->rows as $row) {
							$balance -= $row['deposit'];
							if (!empty($row['payments'])) {
								foreach (unserialize($row['payments']) as $payment) {
									$add_payment[] = array(
										'payment_date'			=> $payment['payment_date'],
										'payment_description'	=> $payment['payment_description'],
										'payment_amount'		=> $payment['payment_amount']
									);
									$balance -= $payment['payment_amount'];
								}
							}
						}
					}
					$date = time();
					$add_payment[] = array(
						'payment_date'			=> $date,
						'payment_description'	=> $description,
						'payment_amount'		=> $amount
					);
					$balance -= $amount;
					if ($balance <= 0) {
						$paid_in_full = 1;
						$order_paid = 1;
					} else {
						$paid_in_full = 0;
						$order_paid = 0;
					}
					$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$this->config->get('layaway_order_status_id') . "' WHERE order_id = '" . (int)$order_id . "'");
					$this->db->query("UPDATE " . DB_PREFIX . "order_layaway SET payments = '" . $this->db->escape(serialize($add_payment)) . "', paid_in_full = '" . (int)$paid_in_full . "' WHERE order_id = '" . (int)$order_id . "'");
					if (isset($this->session->data['customer_info']) && $order_paid) {
						if (isset($this->session->data['payment_method']) && ($this->session->data['payment_method']['code'] == "pp_pro"
							|| $this->session->data['payment_method']['code'] == "pp_pro_uk"
							|| $this->session->data['payment_method']['code'] == "authorizenet_aim"
							|| $this->session->data['payment_method']['code'] == "eprocessingnetwork"
							|| $this->session->data['payment_method']['code'] == "sagepay_direct"
							|| $this->session->data['payment_method']['code'] == "perpetual_payments"
							|| $this->session->data['payment_method']['code'] == "usaepay_server"
							|| $this->session->data['payment_method']['code'] == "paymentsense_direct"
							|| $this->session->data['payment_method']['code'] == "paypal_express")) {
								if (isset($this->session->data['store_id'])) {
									$order_status_id = $this->session->data['store_config']['config_order_status_id'];
								} else {
									$order_status_id = $this->config->get('config_order_status_id');
								}
								$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_paid = 1, order_status_id = '" . (int)$order_status_id . "' WHERE order_id = '" . (int)$order_id . "'");
						}
					}
					$subject = sprintf($this->language->get('text_layaway_subject'), $this->config->get('layaway_button_name'), $this->config->get('config_name'));
					$message = sprintf($this->language->get('text_layaway_received'), $this->config->get('layaway_button_name'), $this->currency->format($amount, $this->config->get('config_currency'))) . "\n\n";
					$message .= sprintf($this->language->get('text_layaway_total'), $this->config->get('layaway_button_name'));
					if ($order_info['customer_id']) {
						$message .= $this->language->get('text_link') . "\n";
						$message .= html_entity_decode(str_replace("admin/", "", $order_info['store_url']) . 'index.php?route=account/order/info&order_id=' . $order_id, ENT_QUOTES, 'UTF-8') . "\n\n";
					}
					$message .= $this->language->get('text_footer');
					$mail = new Mail();
					$mail->protocol = $this->config->get('config_mail_protocol');
					$mail->parameter = $this->config->get('config_mail_parameter');
					$mail->hostname = $this->config->get('config_smtp_host');
					$mail->username = $this->config->get('config_smtp_username');
					$mail->password = $this->config->get('config_smtp_password');
					$mail->port = $this->config->get('config_smtp_port');
					$mail->timeout = $this->config->get('config_smtp_timeout');
					$mail->setTo($order_info['email']);
					$mail->setFrom($this->config->get('config_email'));
					$mail->setSender($order_info['store_name']);
					$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
					$mail->setText(html_entity_decode($message, ENT_QUOTES, 'UTF-8'));
					$mail->send();
					return;
				}
				
				public function deleteLayaway($order_id) {
					$this->db->query("DELETE FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
				}

				public function getLayaways($order_id, $start = 0, $limit = 10) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "' ORDER BY date_added DESC LIMIT " . (int)$start . "," . (int)$limit);
					return $query->rows;
				}

				public function getTotalLayaways($order_id) {
					$query = $this->db->query("SELECT COUNT(*) AS total  FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					return $query->row['total'];
				}

				public function getLayawayTotal($order_id) {
					$query = $this->db->query("SELECT SUM(amount) AS total FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					return $query->row['total'];
				}

				public function getCustomer($customer_id) {
					$query = $this->db->query("SELECT DISTINCT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "'");
					return $query->row;
				}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="before"><![CDATA[
				<td><?php echo $entry_price; ?></td>
			]]></search>
			<add><![CDATA[
					<td><?php echo $entry_payment_due; ?></td>
					<td><input class="date" type="text" name="payment_due" value="<?php echo $payment_due; ?>" size="10" /></td>
				</tr>
				<tr>
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/common/home.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				<td class="right"><?php echo $order['total']; ?></td>
			]]></search>
			<add><![CDATA[
				<td class="right" style="color: <?php if (isset($color[$order['order_id']])) { echo $color[$order['order_id']]; } else { echo '#000'; }; ?>;"><?php echo $order['total']; ?></td>
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/order_form.tpl" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				<a onclick="$('#form').submit();" class="button">
			]]></search>
			<add><![CDATA[
				<a id="processOrder" class="button">
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				<input type="hidden" name="payment_method" value="<?php echo $payment_method; ?>" />
			]]></search>
			<add><![CDATA[
				<span id="layaway_line" style="display: none; padding-left: 10px;"><?php echo $this->config->get('layaway_button_name'); ?> Deposit: <input type="text" name="layaway_deposit" value="" size="5" /><input type="hidden" name="min_deposit" value="" /><input type="hidden" name="max_deposit" value="" /></span>
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
				<script type="text/javascript"><!--
			]]></search>
			<add><![CDATA[
				<script type="text/javascript"><!--
					$(document).ready(function() {
						$('#processOrder').on('click', function() {
							var error = 0;
							if ($('select[name=\'payment\']').val() == 'layaway') {
								if (parseFloat($('input[name=\'layaway_deposit\']').val()) < parseFloat($('input[name=\'min_deposit\']').val())) {
									error = 1;
								} else if (parseFloat($('input[name=\'layaway_deposit\']').val()) > parseFloat($('input[name=\'max_deposit\']').val())) {
									error = 1;
								}
							}
							if (error == 0) {
								$('#form').submit();
							} else {
								return false;
							}
						});
						$('input[name=\'layaway_deposit\']').on('blur', function() {
							if (parseFloat($(this).val()) < parseFloat($('input[name=\'min_deposit\']').val())) {
								alert('Deposit must be at least ' + $('input[name=\'min_deposit\']').val());
								$('input[name=\'layaway_deposit\']').val($('input[name=\'min_deposit\']').val());
								return false;
							} else if (parseFloat($(this).val()) > parseFloat($('input[name=\'max_deposit\']').val())) {
								alert('Deposit cannot be more than ' + $('input[name=\'max_deposit\']').val());
								$('input[name=\'layaway_deposit\']').val($('input[name=\'min_deposit\']').val());
								return false;
							}
						});
						$('select[name=\'payment\']').on('change', function() {
							if ($('select[name=\'payment\']').val() == 'layaway') {
								data  = '#tab-customer input[type=\'text\'], #tab-customer input[type=\'hidden\'], #tab-customer input[type=\'radio\']:checked, #tab-customer input[type=\'checkbox\']:checked, #tab-customer select, #tab-customer textarea, ';
								data += '#tab-payment input[type=\'text\'], #tab-payment input[type=\'hidden\'], #tab-payment input[type=\'radio\']:checked, #tab-payment input[type=\'checkbox\']:checked, #tab-payment select, #tab-payment textarea, ';
								data += '#tab-shipping input[type=\'text\'], #tab-shipping input[type=\'hidden\'], #tab-shipping input[type=\'radio\']:checked, #tab-shipping input[type=\'checkbox\']:checked, #tab-shipping select, #tab-shipping textarea, ';
								if ($(this).attr('id') == 'button-product') {
									data += '#tab-product input[type=\'text\'], #tab-product input[type=\'hidden\'], #tab-product input[type=\'radio\']:checked, #tab-product input[type=\'checkbox\']:checked, #tab-product select, #tab-product textarea, ';
								} else {
									data += '#product input[type=\'text\'], #product input[type=\'hidden\'], #product input[type=\'radio\']:checked, #product input[type=\'checkbox\']:checked, #product select, #product textarea, ';
								}
								if ($(this).attr('id') == 'button-voucher') {
									data += '#tab-voucher input[type=\'text\'], #tab-voucher input[type=\'hidden\'], #tab-voucher input[type=\'radio\']:checked, #tab-voucher input[type=\'checkbox\']:checked, #tab-voucher select, #tab-voucher textarea, ';
								} else {
									data += '#voucher input[type=\'text\'], #voucher input[type=\'hidden\'], #voucher input[type=\'radio\']:checked, #voucher input[type=\'checkbox\']:checked, #voucher select, #voucher textarea, ';
								}
								data += '#tab-total input[type=\'text\'], #tab-total input[type=\'hidden\'], #tab-total input[type=\'radio\']:checked, #tab-total input[type=\'checkbox\']:checked, #tab-total select, #tab-total textarea';
								$.ajax({
									url: '<?php echo $store_url; ?>index.php?route=checkout/manual/getDeposit&token=<?php echo $token; ?>',
									type: 'POST',
									dataType: 'json',
									data: $(data),
									success: function(json) {
										$('input[name=\'layaway_deposit\']').val(json.required_deposit);
										$('input[name=\'min_deposit\']').val(json.required_deposit);
										$('input[name=\'max_deposit\']').val(json.maximum_payment);
										$('#layaway_line').show();
									},
									error: function(xhr,j,i) {
										alert(i);
									}
								});
							} else {
								$('#layaway_line').hide();
								$('input[name=\'min_deposit\']').val('');
								$('input[name=\'max_deposit\']').val('');
							}
						});
					});
				//--></script>
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/order_info.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				<a href="#tab-history"><?php echo $tab_order_history; ?></a>
			]]></search>
			<add><![CDATA[
				<a href="#tab-history"><?php echo $tab_order_history; ?></a>
				<?php if ($active_layaway == 1) { ?>
					<a href="#tab-layaway"><?php echo $tab_layaway; ?></a>
				<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				<a href="#tab-history"><?php echo $tab_history; ?></a>
			]]></search>
			<add><![CDATA[
				<a href="#tab-history"><?php echo $tab_history; ?></a>
				<?php if ($active_layaway == 1) { ?>
					<a href="#tab-layaway"><?php echo $tab_layaway; ?></a>
				<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				<div id="tab-history" class="vtabs-content">
			]]></search>
			<add><![CDATA[
				<?php if (isset($active_layaway) && $active_layaway == 1) { ?>
					<div id="tab-layaway" class="vtabs-content">
						<table class="form">
							<tr>
								<div id="layaway"></div>
								<tr>
									<div style="font-weight:bold; font-size:16px;color:#2755bb; margin:10px; cursor:auto;"><?php echo$text_apply_payment; ?></div>
									<tr>
										<td><?php echo $entry_description; ?></td>
										<td><input type="text" name="description" value="<?php echo $this->config->get('layaway_button_name') . " Payment"; ?>" /></td>
									</tr>
									<tr>
										<td><?php echo $entry_amount; ?></td>
										<td><input type="text" name="amount" value="0.00" /></td>
									</tr>
									<tr>
										<td colspan="2" style="text-align: left;"><a id="button-reward" class="button" onclick="addLayaway();"><span>Apply Payment</span></a></td>
									</tr>
								</tr>
							</tr>
						</table>
					</div>
				<?php } ?>
				<?php if (isset($active_layaway)) { ?>
					<script type="text/javascript">
						$('#layaway .pagination a').live('click', function() {
						$('#layaway').load(this.href);
						return false;
					});			
					$('#layaway').load('index.php?route=sale/order/layaway&token=<?php echo $token; ?>&order_id=<?php echo $order_id; ?>');
					function addLayaway() {
						$.ajax({
							url: 'index.php?route=sale/order/layaway&token=<?php echo $token; ?>&order_id=<?php echo $order_id; ?>&customer_id=<?php echo $customer_id; ?>',
							type: 'post',
							dataType: 'html',
							data: 'description=' + encodeURIComponent($('#tab-layaway input[name=\'description\']').val()) + '&amount=' + encodeURIComponent($('#tab-layaway input[name=\'amount\']').val()),
							beforeSend: function() {
								$('.success, .warning').remove();
								$('#button-layaway').attr('disabled', true);
								$('#layaway').before('<div class="attention"><img src="view/image/loading.gif" alt="" /> <?php echo $text_wait; ?></div>');
							},
							complete: function() {
								$('#button-layaway').attr('disabled', false);
								$('.attention').remove();
							},
							success: function(html) {
								$('#layaway').html(html);			
								$('#tab-layaway input[name=\'amount\']').val('');
								$('#tab-layaway input[name=\'description\']').val('');
							}
						});
					}
					</script>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/order_invoice.tpl">
		<operation>
			<search position="replace" offset="4"><![CDATA[
				<?php foreach ($order['total'] as $total) { ?>
			]]></search>
			<add><![CDATA[
				<?php foreach ($order['total'] as $total) { ?>
					<?php if ($total['code'] == "total" && $order['layaway_deposit']) { ?>
						<tr>
							<td align="right" colspan="4"><b><?php echo $total['title']; ?>:</b></td>
							<td align="right"><?php echo $total['text']; ?></td>
						</tr>
						<tr>
							<td align="right" colspan="4"><b><?php echo $text_layaway_deposit; ?>:</b></td>
							<td align="right"><?php echo $order['layaway_deposit']; ?></td>
						</tr>
						<tr>
							<td align="right" colspan="4"><b><?php echo $text_layaway_balance; ?>:</b></td>
							<td align="right"><?php echo $order['layaway_balance']; ?></td>
						</tr>
					<?php } else { ?>
						<tr>
							<td align="right" colspan="4"><b><?php echo $total['title']; ?>:</b></td>
							<td align="right"><?php echo $total['text']; ?></td>
						</tr>
					<?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/order_list.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				<td class="right"><?php echo $order['total']; ?></td>
			]]></search>
			<add><![CDATA[
				<td class="right" style="color: <?php if (isset($color[$order['order_id']])) { echo $color[$order['order_id']]; } else { echo '#000'; }; ?>;"><?php echo $order['total']; ?></td>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/account/order.php">
		<operation>
			<search position="before"><![CDATA[
				public function info() { 
			]]></search>
			<add><![CDATA[
				public function layaway_payment() {
					$this->session->data['layaway_order_id'] = $this->request->get['order_id'];
					$this->session->data['layaway_payment'] = array(
						'order_id'	=> $this->request->get['order_id'],
						'amount'	=> $this->request->post['payment_amount']
					);
					if (version_compare(VERSION, '1.5.2', '<')) {
						$this->session->data['vouchers'][] = array(
							'description'      => $this->config->get('layaway_button_name') . ' Payment',
							'to_name'          => '',
							'to_email'         => '',
							'from_name'        => '',
							'from_email'       => '',
							'voucher_theme_id' => '',
							'message'          => '',
							'amount'           => $this->currency->convert($this->session->data['layaway_payment']['amount'], $this->currency->getCode(), $this->config->get('config_currency'))
						);
						$this->cart->clear();
						$this->redirect($this->url->link('checkout/checkout'));
					} else {
						$this->redirect($this->url->link('account/voucher'));
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->data['column_comment'] = $this->language->get('column_comment');
			]]></search>
			<add><![CDATA[
				$this->data['column_amount'] = $this->language->get('column_amount');
				$this->data['column_description'] = $this->language->get('column_description');
				$this->data['column_balance'] = $this->language->get('column_balance');
				$this->data['text_layaway_payment_history'] = sprintf($this->language->get('text_layaway_payment_history'), $this->config->get('layaway_button_name'));
				$this->data['entry_payment_amount'] = sprintf($this->language->get('entry_payment_amount'), $this->config->get('layaway_button_name'));
				$this->data['button_payment'] = $this->language->get('button_payment');
				$this->data['error_payment_amount'] = $this->language->get('error_payment_amount');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->data['continue'] = $this->url->link('account/order', '', 'SSL');
			]]></search>
			<add><![CDATA[
				$this->data['layaways'] = array();
				$results = $this->model_account_order->getLayawayByOrderId($this->request->get['order_id']);
				$balance = $order_info['total'];
				foreach ($results as $result) {
					$balance -= $result['deposit'];
					$this->data['layaways'][] = array(
						'date_added'	 => date($this->language->get('date_format_short'), $result['date_added']),
						'amount'    	 => $this->currency->format($result['deposit']),
						'description'    => sprintf($this->language->get('text_layaway_deposit'), $this->config->get('layaway_button_name')),
						'balance'		 => $this->currency->format($balance)
					);
					if (!empty($result['payments'])) {
						foreach (unserialize($result['payments']) as $payment) {
							$balance -= $payment['payment_amount'];
							$this->data['layaways'][] = array(
								'date_added'	 => date($this->language->get('date_format_short'), $payment['payment_date']),
								'amount'    	 => $this->currency->format($payment['payment_amount']),
								'description'    => sprintf($this->language->get('text_layaway_payment'), $this->config->get('layaway_button_name')),
								'balance'		 => $this->currency->format($balance)
							);
						}
					}
				}
				$this->data['balance'] = number_format($balance, 2, ".", "");
				$this->data['action'] = $this->url->link('account/order/layaway_payment', '&order_id=' . $this->request->get['order_id'], 'SSL');
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/account/voucher.php" error="skip">
		<operation error="skip">
			<search position="replace"><![CDATA[
				if (($this->request->server['REQUEST_METHOD'] == 'POST') && $this->validate()) {
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_payment'])) {
					$this->cart->clear();
					$this->session->data['vouchers'][] = array(
						'description'      => $this->config->get('layaway_button_name') . ' Payment',
						'to_name'          => '',
						'to_email'         => '',
						'from_name'        => '',
						'from_email'       => '',
						'voucher_theme_id' => '',
						'message'          => '',
						'amount'           => $this->currency->convert($this->session->data['layaway_payment']['amount'], $this->currency->getCode(), $this->config->get('config_currency'))
					);
					$this->redirect($this->url->link('checkout/checkout'));
				} elseif (($this->request->server['REQUEST_METHOD'] == 'POST') && $this->validate()) {
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/cart.php">
		<operation error="skip">
			<search position="after"><![CDATA[
				$this->language->load('checkout/cart');
			]]></search>
			<add><![CDATA[
				if (!$this->cart->hasProducts()) {
					unset($this->session->data['layaway_payment']);
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/confirm.php">
		<operation>
			<search position="after" index="2"><![CDATA[
				foreach ($this->cart->getProducts() as $product) {
			]]></search>
			<add><![CDATA[
				$payment_text = '';
				if (isset($this->session->data['layaway_deposit'])) {
					if ($product['payment_due']) {
						if ($product['payment_due'] > time()) {
							$payment_text = sprintf($this->language->get('text_payment_text'), date($this->language->get('date_format_short'), $product['payment_due']));
						} else {
							$payment_text = sprintf($this->language->get('text_not_eligible'), $this->config->get('layaway_button_name'));
						}
					} else {
						$due_date = strtotime('Today + ' . $this->config->get('layaway_timeframe') . ' days');
						$payment_text = sprintf($this->language->get('text_payment_text'), date($this->language->get('date_format_short'), $due_date));
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after" index="2"><![CDATA[
				=> $product['product_id'],
			]]></search>
			<add><![CDATA[
				'payment_text'	=> $payment_text,
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				$this->session->data['order_id'] = $this->model_checkout_order->addOrder($data);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['text_layaway_deposit'] = sprintf($this->language->get('text_layaway_deposit'), $this->config->get('layaway_button_name'));
					$this->data['layaway_deposit'] = $this->currency->format($this->session->data['layaway_deposit']);
					$data['layaway_deposit'] = $this->session->data['layaway_deposit'];
				} else {
					$data['layaway_deposit'] = 0;
				}
				if (!isset($this->session->data['layaway_payment'])) {
					$this->session->data['order_id'] = $this->model_checkout_order->addOrder($data);
				} else {
					$this->session->data['order_id'] = $this->session->data['layaway_payment']['order_id'];
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				$this->session->data['order_id'] = $this->model_checkout_order->create($data);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['text_layaway_deposit'] = sprintf($this->language->get('text_layaway_deposit'), $this->config->get('layaway_button_name'));
					$this->data['layaway_deposit'] = $this->currency->format($this->session->data['layaway_deposit']);
					$data['layaway_deposit'] = $this->session->data['layaway_deposit'];
				} else {
					$data['layaway_deposit'] = 0;
				}
				if (!isset($this->session->data['layaway_payment'])) {
					$this->session->data['order_id'] = $this->model_checkout_order->create($data);
				} else {
					$this->session->data['order_id'] = $this->session->data['layaway_payment']['order_id'];
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/quickcheckout/confirm.php" error="skip">
		<operation>
			<search position="after" index="2"><![CDATA[
				foreach ($this->cart->getProducts() as $product) {
			]]></search>
			<add><![CDATA[
				$payment_text = '';
				if (isset($this->session->data['layaway_deposit'])) {
					if ($product['payment_due']) {
						if ($product['payment_due'] > time()) {
							$payment_text = sprintf($this->language->get('text_payment_text'), date($this->language->get('date_format_short'), $product['payment_due']));
						} else {
							$payment_text = sprintf($this->language->get('text_not_eligible'), $this->config->get('layaway_button_name'));
						}
					} else {
						$due_date = strtotime('Today + ' . $this->config->get('layaway_timeframe') . ' days');
						$payment_text = sprintf($this->language->get('text_payment_text'), date($this->language->get('date_format_short'), $due_date));
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after" index="2"><![CDATA[
				=> $product['product_id'],
			]]></search>
			<add><![CDATA[
				'payment_text'	=> $payment_text,
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$this->session->data['order_id'] = $this->model_checkout_order->addOrder($data);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['text_layaway_deposit'] = sprintf($this->language->get('text_layaway_deposit'), $this->config->get('layaway_button_name'));
					$this->data['layaway_deposit'] = $this->currency->format($this->session->data['layaway_deposit']);
					$data['layaway_deposit'] = $this->session->data['layaway_deposit'];
				} else {
					$data['layaway_deposit'] = 0;
				}
				if (!isset($this->session->data['layaway_payment'])) {
					$this->session->data['order_id'] = $this->model_checkout_order->addOrder($data);
				} else {
					$this->session->data['order_id'] = $this->session->data['layaway_payment']['order_id'];
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/manual.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$results = $this->model_setting_extension->getExtensions('payment');
			]]></search>
			<add><![CDATA[
				$method_data = array(
					'code'			=> 'layaway',
					'title'			=> $this->config->get('layaway_button_name'),
					'sort_order'	=> 99
				);
				$json['payment_method']['layaway'] = $method_data;
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				public function index() {
			]]></search>
			<add><![CDATA[
				public function getDeposit() {
					$json = array();
					$this->load->library('user');
					$this->user = new User($this->registry);
					if ($this->user->isLogged() && $this->user->hasPermission('modify', 'sale/order')) {	
						$this->load->model('setting/setting');
						$settings = $this->model_setting_setting->getSetting('config', $this->request->post['store_id']);
						foreach ($settings as $key => $value) {
							$this->config->set($key, $value);
						}
						if ($this->request->post['customer_id']) {
							$this->load->model('account/customer');
							$customer_info = $this->model_account_customer->getCustomer($this->request->post['customer_id']);
							if ($customer_info) {
								$this->customer->login($customer_info['email'], '', true);
								$this->cart->clear();
							}
						} else {
							$this->config->set('config_customer_group_id', $this->request->post['customer_group_id']);
						}
						$layaway_amount = 0;
						$this->load->model('catalog/product');
						if (isset($this->request->post['order_product'])) {
							foreach ($this->request->post['order_product'] as $order_product) {
								$product_info = $this->model_catalog_product->getProduct($order_product['product_id']);
								if ($product_info) {	
									$option_data = array();
									if (isset($order_product['order_option'])) {
										foreach ($order_product['order_option'] as $option) {
											if ($option['type'] == 'select' || $option['type'] == 'radio' || $option['type'] == 'image') { 
												$option_data[$option['product_option_id']] = $option['product_option_value_id'];
											} elseif ($option['type'] == 'checkbox') {
												$option_data[$option['product_option_id']][] = $option['product_option_value_id'];
											} elseif ($option['type'] == 'text' || $option['type'] == 'textarea' || $option['type'] == 'file' || $option['type'] == 'date' || $option['type'] == 'datetime' || $option['type'] == 'time') {
												$option_data[$option['product_option_id']] = $option['value'];						
											}
										}
									}
									$this->cart->add($order_product['product_id'], $order_product['quantity'], $option_data);
								}
							}
						}
						foreach ($this->cart->getProducts() as $product) {
							$layaway_product = 1;
							$payment_query = $this->db->query("SELECT payment_due FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$product['product_id'] . "'");
							if ($payment_query->row['payment_due'] && $payment_query->row['payment_due'] < time()) {
								$layaway_product = 0;
							}
							if (!$layaway_product) {
								$layaway_amount += $product['total'];
							} else {
								if ($this->config->get('layaway_per_product')) {
									if ($this->config->get('layaway_deposit_type') == "percent") {
										$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
									} else {
										$layaway_amount += $this->config->get('layaway_min_deposit') * $product['quantity'];
									}
								} else {
									if ($this->config->get('layaway_deposit_type') == "percent") {
										$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
									} else {
										$layaway_amount += $this->config->get('layaway_min_deposit');
									}
								}
							}
						}
						$required_deposit = number_format($layaway_amount, 2, ".", "");
						$this->load->model('setting/extension');
						$order_total = array();
						$total = 0;
						$taxes = $this->cart->getTaxes();
						$sort_order = array(); 
						$results = $this->model_setting_extension->getExtensions('total');
						foreach ($results as $key => $value) {
							$sort_order[$key] = $this->config->get($value['code'] . '_sort_order');
						}
						array_multisort($sort_order, SORT_ASC, $results);
						foreach ($results as $result) {
							if ($this->config->get($result['code'] . '_status')) {
								$this->load->model('total/' . $result['code']);
								$this->{'model_total_' . $result['code']}->getTotal($order_total, $total, $taxes);
							}
							$sort_order = array(); 
							foreach ($order_total as $key => $value) {
								$sort_order[$key] = $value['sort_order'];
							}
							array_multisort($sort_order, SORT_ASC, $order_total);				
						}
						$json = array(
							'required_deposit'	=> $required_deposit,
							'maximum_payment'	=> $total
						);
					}
					echo json_encode($json);
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/payment_method.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->data['text_comments'] = $this->language->get('text_comments');
			]]></search>
			<add><![CDATA[
				$this->data['error_not_registered'] = sprintf($this->language->get('error_not_registered'), $this->config->get('layaway_button_name'));
				$customer_groups_allowed = $this->config->get('layaway_customer_groups');
				$layaway_allowed = 0;
				foreach ($this->cart->getProducts() as $product) {
					if ($product['layaway_product']) {
						$layaway_allowed = 1;
						break;
					}
				}
				if ($customer_groups_allowed && $layaway_allowed) {
					if (!$this->customer->isLogged() || in_array($this->customer->getCustomerGroupId(), $customer_groups_allowed)) {
						if (!$this->customer->isLogged()) {
							$this->data['need_to_register'] = 1;
						}
						if (isset($this->session->data['layaway_cart'])) {
							$this->data['layaway_cart'] = 1;
						}
						$store_allowed = array();
						$store_allowed = $this->config->get('layaway_active_stores');
						$this_store = $this->config->get('config_store_id');
						if (!empty($store_allowed)) {
							foreach ($store_allowed as $store) {
								if ($store == $this_store) {
									if ($this->config->get('layaway_allow_deposit') && $this->config->get('layaway_allow_admin') && !isset($this->session->data['layaway_payment'])) {
										$this->data['layaway_is_active'] = 1;
										$min_amount = $this->config->get('layaway_min_amount');
										if ($min_amount > $this->cart->getSubtotal()) {
											$this->data['below_minimum'] = 1;
											$this->data['below_minimum_msg'] = sprintf($this->language->get('error_below_minimum'), $min_amount, $this->config->get('layaway_button_name'), $this->config->get('layaway_button_name'),  $this->url->link('common/home', '', 'SSL'));
										}
										$layaway_amount = 0;
										foreach ($this->cart->getProducts() as $product) {
											if (!$product['layaway_product']) {
												$layaway_amount += $product['total'];
											} else {
												if ($this->config->get('layaway_per_product')) {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit') * $product['quantity'];
													}
												} else {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit');
													}
												}
											}
										}
										$this->data['required_deposit'] = number_format($layaway_amount, 2, ".", "");
										$this->data['order_total'] = number_format($total, 2, ".", "");
										$this->data['entry_layaway_deposit'] = sprintf($this->language->get('entry_layaway_deposit'), $this->config->get('layaway_button_name'));
										$this->data['entry_layaway_amount'] = sprintf($this->language->get('entry_layaway_amount'), $this->config->get('layaway_button_name'), $this->currency->format($layaway_amount));
										$this->data['error_amount_low'] = sprintf($this->language->get('error_amount_low'), $this->currency->format($layaway_amount));
										$this->data['error_amount_high'] = sprintf($this->language->get('error_amount_high'), $this->currency->format($total));
									}
								}
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->session->data['comment'] = strip_tags($this->request->post['comment']);
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['layaway_deposit'])) {
					$this->session->data['layaway_deposit'] = $this->request->post['layaway_amount'];
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/payment.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->data['text_comments'] = $this->language->get('text_comments');
			]]></search>
			<add><![CDATA[
				$this->data['error_not_registered'] = sprintf($this->language->get('error_not_registered'), $this->config->get('layaway_button_name'));
				$customer_groups_allowed = $this->config->get('layaway_customer_groups');
				$layaway_allowed = 0;
				foreach ($this->cart->getProducts() as $product) {
					if ($product['layaway_product']) {
						$layaway_allowed = 1;
						break;
					}
				}
				if ($customer_groups_allowed && $layaway_allowed) {
					if (!$this->customer->isLogged() || in_array($this->customer->getCustomerGroupId(), $customer_groups_allowed)) {
						if (!$this->customer->isLogged()) {
							$this->data['need_to_register'] = 1;
						}
						if (isset($this->session->data['layaway_cart'])) {
							$this->data['layaway_cart'] = 1;
						}
						$store_allowed = $this->config->get('layaway_active_stores');
						$this_store = $this->config->get('config_store_id');
						foreach ($store_allowed as $store) {
							if ($store == $this_store) {
								if ($this->config->get('layaway_allow_deposit') && $this->config->get('layaway_allow_admin') && !isset($this->session->data['layaway_payment'])) {
									$this->data['layaway_is_active'] = 1;
									$min_amount = $this->config->get('layaway_min_amount');
									if ($min_amount > $this->cart->getSubtotal()) {
										$this->data['below_minimum'] = 1;
										if (version_compare(VERSION, '1.5.2', '<')) {
											$this->data['below_minimum_msg'] = sprintf($this->language->get('error_below_minimum'), $min_amount, $this->config->get('layaway_button_name'), $this->config->get('layaway_button_name'), HTTP_SERVER . 'index.php?route=common/home');
										} else {
											$this->data['below_minimum_msg'] = sprintf($this->language->get('error_below_minimum'), $min_amount, $this->config->get('layaway_button_name'), $this->config->get('layaway_button_name'),  $this->url->link('common/home', '', 'SSL'));
										}
									}
									$layaway_amount = 0;
									foreach ($this->cart->getProducts() as $product) {
										if (!$product['layaway_product']) {
											$layaway_amount += $product['total'];
										} else {
											if ($this->config->get('layaway_per_product')) {
												if ($this->config->get('layaway_deposit_type') == "percent") {
													$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
												} else {
													$layaway_amount += $this->config->get('layaway_min_deposit') * $product['quantity'];
												}
											} else {
												if ($this->config->get('layaway_deposit_type') == "percent") {
													$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
												} else {
													$layaway_amount += $this->config->get('layaway_min_deposit');
												}
											}
										}
									}
									$this->data['required_deposit'] = number_format($layaway_amount, 2, ".", "");
									$this->data['order_total'] = number_format($total, 2, ".", "");
									$this->data['entry_layaway_deposit'] = sprintf($this->language->get('entry_layaway_deposit'), $this->config->get('layaway_button_name'));
									$this->data['entry_layaway_amount'] = sprintf($this->language->get('entry_layaway_amount'), $this->config->get('layaway_button_name'), $this->currency->format($layaway_amount));
									$this->data['error_amount_low'] = sprintf($this->language->get('error_amount_low'), $this->currency->format($layaway_amount));
									$this->data['error_amount_high'] = sprintf($this->language->get('error_amount_high'), $this->currency->format($total));
								}
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->session->data['comment'] = strip_tags($this->request->post['comment']);
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['layaway_deposit'])) {
					$this->session->data['layaway_deposit'] = $this->request->post['layaway_amount'];
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/quickcheckout/payment_method.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->data['text_comments'] = $this->language->get('text_comments');
			]]></search>
			<add><![CDATA[
				$this->data['error_not_registered'] = sprintf($this->language->get('error_not_registered'), $this->config->get('layaway_button_name'));
				$customer_groups_allowed = $this->config->get('layaway_customer_groups');
				$layaway_allowed = 0;
				foreach ($this->cart->getProducts() as $product) {
					if ($product['layaway_product']) {
						$layaway_allowed = 1;
						break;
					}
				}
				if ($customer_groups_allowed && $layaway_allowed) {
					if (!$this->customer->isLogged() || in_array($this->customer->getCustomerGroupId(), $customer_groups_allowed)) {
						if (!$this->customer->isLogged()) {
							$this->data['need_to_register'] = 1;
						}
						if (isset($this->session->data['layaway_cart'])) {
							$this->data['layaway_cart'] = 1;
						}
						$store_allowed = array();
						$store_allowed = $this->config->get('layaway_active_stores');
						$this_store = $this->config->get('config_store_id');
						if (!empty($store_allowed)) {
							foreach ($store_allowed as $store) {
								if ($store == $this_store) {
									if ($this->config->get('layaway_allow_deposit') && $this->config->get('layaway_allow_admin') && !isset($this->session->data['layaway_payment'])) {
										$this->data['layaway_is_active'] = 1;
										$min_amount = $this->config->get('layaway_min_amount');
										if ($min_amount > $this->cart->getSubtotal()) {
											$this->data['below_minimum'] = 1;
											$this->data['below_minimum_msg'] = sprintf($this->language->get('error_below_minimum'), $min_amount, $this->config->get('layaway_button_name'), $this->config->get('layaway_button_name'),  $this->url->link('common/home', '', 'SSL'));
										}
										$layaway_amount = 0;
										foreach ($this->cart->getProducts() as $product) {
											if (!$product['layaway_product']) {
												$layaway_amount += $product['total'];
											} else {
												if ($this->config->get('layaway_per_product')) {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit') * $product['quantity'];
													}
												} else {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit');
													}
												}
											}
										}
										$this->data['required_deposit'] = number_format($layaway_amount, 2, ".", "");
										$this->data['order_total'] = number_format($total, 2, ".", "");
										$this->data['entry_layaway_deposit'] = sprintf($this->language->get('entry_layaway_deposit'), $this->config->get('layaway_button_name'));
										$this->data['entry_layaway_amount'] = sprintf($this->language->get('entry_layaway_amount'), $this->config->get('layaway_button_name'), $this->currency->format($layaway_amount));
										$this->data['error_amount_low'] = sprintf($this->language->get('error_amount_low'), $this->currency->format($layaway_amount));
										$this->data['error_amount_high'] = sprintf($this->language->get('error_amount_high'), $this->currency->format($total));
									}
								}
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->session->data['comment'] = strip_tags($this->request->post['comment']);
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['layaway_deposit'])) {
					$this->session->data['layaway_deposit'] = $this->request->post['layaway_amount'];
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/quickcheckout/payment.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->data['text_comments'] = $this->language->get('text_comments');
			]]></search>
			<add><![CDATA[
				$this->data['error_not_registered'] = sprintf($this->language->get('error_not_registered'), $this->config->get('layaway_button_name'));
				$customer_groups_allowed = $this->config->get('layaway_customer_groups');
				$layaway_allowed = 0;
				foreach ($this->cart->getProducts() as $product) {
					if ($product['layaway_product']) {
						$layaway_allowed = 1;
						break;
					}
				}
				if ($customer_groups_allowed && $layaway_allowed) {
					if (!$this->customer->isLogged() || in_array($this->customer->getCustomerGroupId(), $customer_groups_allowed)) {
						if (!$this->customer->isLogged()) {
							$this->data['need_to_register'] = 1;
						}
						if (isset($this->session->data['layaway_cart'])) {
							$this->data['layaway_cart'] = 1;
						}
						$store_allowed = array();
						$store_allowed = $this->config->get('layaway_active_stores');
						$this_store = $this->config->get('config_store_id');
						if (!empty($store_allowed)) {
							foreach ($store_allowed as $store) {
								if ($store == $this_store) {
									if ($this->config->get('layaway_allow_deposit') && $this->config->get('layaway_allow_admin') && !isset($this->session->data['layaway_payment'])) {
										$this->data['layaway_is_active'] = 1;
										$min_amount = $this->config->get('layaway_min_amount');
										if ($min_amount > $this->cart->getSubtotal()) {
											$this->data['below_minimum'] = 1;
											$this->data['below_minimum_msg'] = sprintf($this->language->get('error_below_minimum'), $min_amount, $this->config->get('layaway_button_name'), $this->config->get('layaway_button_name'),  $this->url->link('common/home', '', 'SSL'));
										}
										$layaway_amount = 0;
										foreach ($this->cart->getProducts() as $product) {
											if (!$product['layaway_product']) {
												$layaway_amount += $product['total'];
											} else {
												if ($this->config->get('layaway_per_product')) {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit') * $product['quantity'];
													}
												} else {
													if ($this->config->get('layaway_deposit_type') == "percent") {
														$layaway_amount += ($product['total'] * $this->config->get('layaway_min_deposit')) / 100;
													} else {
														$layaway_amount += $this->config->get('layaway_min_deposit');
													}
												}
											}
										}
										$this->data['required_deposit'] = number_format($layaway_amount, 2, ".", "");
										$this->data['order_total'] = number_format($total, 2, ".", "");
										$this->data['entry_layaway_deposit'] = sprintf($this->language->get('entry_layaway_deposit'), $this->config->get('layaway_button_name'));
										$this->data['entry_layaway_amount'] = sprintf($this->language->get('entry_layaway_amount'), $this->config->get('layaway_button_name'), $this->currency->format($layaway_amount));
										$this->data['error_amount_low'] = sprintf($this->language->get('error_amount_low'), $this->currency->format($layaway_amount));
										$this->data['error_amount_high'] = sprintf($this->language->get('error_amount_high'), $this->currency->format($total));
									}
								}
							}
						}
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->session->data['comment'] = strip_tags($this->request->post['comment']);
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['layaway_deposit'])) {
					$this->session->data['layaway_deposit'] = $this->request->post['layaway_amount'];
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/success.php">
		<operation>
			<search position="after"><![CDATA[
				$this->cart->clear();
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit']) || isset($this->session->data['layaway_payment'])) {
					$this->load->model('checkout/order');
					$this->load->model('localisation/currency');
					$this->model_checkout_order->updateLayaway();
					$order_id = $this->session->data['order_id'];
				}
				unset($this->session->data['layaway_deposit']);
				unset($this->session->data['layaway_payment']);
				unset($this->session->data['layaway_cart']);
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/quickcheckout/success.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->cart->clear();
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit']) || isset($this->session->data['layaway_payment'])) {
					$this->load->model('checkout/order');
					$this->load->model('localisation/currency');
					$this->model_checkout_order->updateLayaway();
					$order_id = $this->session->data['order_id'];
				}
				unset($this->session->data['layaway_deposit']);
				unset($this->session->data['layaway_payment']);
				unset($this->session->data['layaway_cart']);
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
				$this->data['title'] = $this->document->getTitle();
			]]></search>
			<add><![CDATA[
				$results = $this->db->query("SHOW COLUMNS FROM " . DB_PREFIX . "order_layaway LIKE 'paid_in_full'");
				if (!$results->num_rows) {
					$this->db->query("ALTER TABLE " . DB_PREFIX . "order_layaway ADD COLUMN paid_in_full TINYINT(1) NOT NULL DEFAULT 0");
					$this->db->query("ALTER TABLE " . DB_PREFIX . "order_layaway ADD COLUMN email_sent TINYINT(1) NOT NULL DEFAULT 0");
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway");
					if ($query->num_rows) {
						foreach ($query->rows as $row) {
							$records = unserialize($row['payments']);
							if (!empty($records)) {
								$order_total = $this->db->query("SELECT total FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$row['order_id'] . "'");
								$amount_paid = $row['deposit'];
								foreach ($records as $record) {
									$amount_paid += $record['payment_amount'];
								}
								if (round($order_total->row['total'],2) == $amount_paid) {
									$this->db->query("UPDATE " . DB_PREFIX . "order_layaway SET paid_in_full = 1 WHERE layaway_id = '" . (int)$row['layaway_id'] . "' AND order_id = '" . (int)$row['order_id'] . "'");
								}
							}
						}
					}
				}
				if ($this->config->get('layaway_allow_deposit') && $this->config->get('layaway_allow_admin') && $this->config->get('layaway_send_emails')) {
					$layaways = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE paid_in_full = 0 AND email_sent = 0");
					if ($layaways->num_rows) {
						$today = time();
						foreach ($layaways->rows as $layaway) {
							$order_products = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$layaway['order_id'] . "'");
							foreach ($order_products->rows as $order_product) {
								$product_query = $this->db->query("SELECT payment_due FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$order_product['product_id'] . "'");
								if ($product_query->row['payment_due'] > 0) {
									$due_date = $product_query->row['payment_due'];
								} else {
									$due_date = $layaway['date_added'] + (86400 * $this->config->get('layaway_timeframe'));
								}
								$reminder_period = $this->config->get('layaway_email_reminder') * 86400;
								if ($due_date - $reminder_period < $today) {
									$order_info = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$layaway['order_id'] . "'");
									if ($order_info->num_rows) {
										$customer_email = $order_info->row['email'];
										$this->load->model('setting/setting');
										$store_info = $this->model_setting_setting->getSetting('config', $order_info->row['store_id']);
										if ($store_info) {
											$store_email = $store_info['config_email'];
										} else {
											$store_email = $this->config->get('config_email');
										}
										$this->language->load('account/layaway');
										$html = sprintf($this->language->get('text_customer_message'), $this->config->get('layaway_button_name'), $layaway['order_id'], $this->config->get('layaway_button_name'), $this->config->get('layaway_timeframe'));
										$subject = sprintf($this->language->get('text_customer_subject'), $this->config->get('layaway_button_name'), $layaway['order_id'], $order_info->row['store_name']);
										$mail = new Mail();
										$mail->protocol = $this->config->get('config_mail_protocol');
										$mail->parameter = $this->config->get('config_mail_parameter');
										$mail->hostname = $this->config->get('config_smtp_host');
										$mail->username = $this->config->get('config_smtp_username');
										$mail->password = $this->config->get('config_smtp_password');
										$mail->port = $this->config->get('config_smtp_port');
										$mail->timeout = $this->config->get('config_smtp_timeout');
										$mail->setTo($customer_email);
										$mail->setFrom($store_email);
										$mail->setSender($order_info->row['store_name']);
										$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
										$mail->setHtml($html);
										$mail->send();
										$html = sprintf($this->language->get('text_store_message'), $this->config->get('layaway_button_name'), $layaway['order_id'], $this->config->get('layaway_button_name'), $this->config->get('layaway_timeframe'));
										$subject = sprintf($this->language->get('text_store_subject'), $this->config->get('layaway_button_name'), $layaway['order_id'], $order_info->row['store_name']);
										$mail = new Mail();
										$mail->protocol = $this->config->get('config_mail_protocol');
										$mail->parameter = $this->config->get('config_mail_parameter');
										$mail->hostname = $this->config->get('config_smtp_host');
										$mail->username = $this->config->get('config_smtp_username');
										$mail->password = $this->config->get('config_smtp_password');
										$mail->port = $this->config->get('config_smtp_port');
										$mail->timeout = $this->config->get('config_smtp_timeout');
										$mail->setTo($store_email);
										$mail->setFrom($store_email);
										$mail->setSender($order_info->row['store_name']);
										$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
										$mail->setHtml($html);
										$mail->send();
										$this->db->query("UPDATE " . DB_PREFIX . "order_layaway SET email_sent = 1 WHERE layaway_id = '" . (int)$layaway['layaway_id'] . "' AND order_id = '" . (int)$layaway['order_id'] . "'");
									}
								}
							}
						}
					}
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/alertpay.php" error="skip">
		<operation>
			<search position="after"><![CDATA[
				$this->data['ap_merchant'] = $this->config->get('alertpay_merchant');
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$this->data['ap_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/authorizenet_aim.php">
		<operation>
			<search position="replace"><![CDATA[
				$data['x_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$data['x_amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], 1.00000, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$data['x_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], 1.00000, false);
					} else {
						$data['x_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], 1.00000, false);
					}
				} else {
					$data['x_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/authorizenet_sim.php">
		<operation>
			<search position="replace"><![CDATA[
				$data['x_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);	 
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$data['x_amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);	
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$data['x_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], 1.00000, false);
					} else {
						$data['x_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], 1.00000, false);
					}
				} else {
					$data['x_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/checkout.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				$amount = 100 * $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], FALSE);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$amount = 100 * $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], FALSE);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$amount = 100 * $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], FALSE);
					} else {
						$amount = 100 * $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], FALSE);
					}
				} else {
					$amount = 100 * $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], FALSE);
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/payment/liqpay.php">
		<operation>
			<search position="replace"><![CDATA[
				$xml .= '	<amount>' . $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false) . '</amount>';
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])){
					$xml .= '	<amount>' . $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false) . '</amount>';
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$xml .= '	<amount>' . $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false) . '</amount>';
					} else {
						$xml .= '	<amount>' . $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false) . '</amount>';
					}
				} else {
					$xml .= '	<amount>' . $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false) . '</amount>';
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/mes.php" error="skip">
		<search position="replace"><![CDATA[
			'transaction_amount'	=> $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, FALSE),
		]]></search>
		<add><![CDATA[
			'transaction_amount'	=> $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], 1.00000, FALSE),
		]]></add>
	</file>
	
	<file name="catalog/controller/payment/moneybookers.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/nochex.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['amount'] = $this->currency->format($order_info['total'], 'GBP', false, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['amount'] = $this->currency->format($this->session->data['layaway_deposit'], 'GBP', false, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), 'GBP', false, false);
					} else {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], 'GBP', false, false);
					}
				} else {
					$this->data['amount'] = $this->currency->format($order_info['total'], 'GBP', false, false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/paymate.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['amt'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false); 
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['amt'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false); 
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['amt'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false); 
					} else {
						$this->data['amt'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false); 
					}
				} else {
					$this->data['amt'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false); 
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$this->data['return'] = $this->url->link('payment/paymate/callback', 'hash=' . md5($order_info['order_id'] . $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false) . $order_info['currency_code'] . $this->config->get('paymate_password')));
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['return'] = $this->url->link('payment/paymate/callback', 'hash=' . md5($order_info['order_id'] . $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false) . $order_info['currency_code'] . $this->config->get('paymate_password')));
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['return'] = $this->url->link('payment/paymate/callback', 'hash=' . md5($order_info['order_id'] . $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false) . $order_info['currency_code'] . $this->config->get('paymate_password')));
					} else {
						$this->data['return'] = $this->url->link('payment/paymate/callback', 'hash=' . md5($order_info['order_id'] . $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false) . $order_info['currency_code'] . $this->config->get('paymate_password')));
					}
				} else {
					$this->data['return'] = $this->url->link('payment/paymate/callback', 'hash=' . md5($order_info['order_id'] . $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false) . $order_info['currency_code'] . $this->config->get('paymate_password')));
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/paypoint.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false); 
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false); 
					} else {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false); 
					}
				} else {
					$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
				if ($this->config->get('paypoint_password')) {
			]]></search>
			<add><![CDATA[
				if ($this->config->get('paypoint_password')) {
					if (isset($this->session->data['layaway_deposit'])) {
						$this->data['digest'] = md5($this->session->data['order_id'] . $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false) . $this->config->get('paypoint_password')); 
					} elseif (isset($this->session->data['layaway_payment'])) {
						if ($this->config->get('layaway_payment_fee')) {
							$this->data['digest'] = md5($this->session->data['order_id'] . $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false) . $this->config->get('paypoint_password')); 
						} else {
							$this->data['digest'] = md5($this->session->data['order_id'] . $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false) . $this->config->get('paypoint_password')); 
						}
					} else {
						$this->data['digest'] = md5($this->session->data['order_id'] . $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false) . $this->config->get('paypoint_password'));
					}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/paypal_express.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				$amt = $this->cart->getTotal();
			]]></search>
			<add><![CDATA[
				if (!isset($this->session->data['layaway_payment'])) {
					$amt = $this->cart->getTotal();
				} else {
					if ($this->config->get('layaway_payment_fee')) {
						$amt = $this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee');
					} else {
						$amt = $this->session->data['layaway_payment']['amount'];
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$this->session->data['ppx']['amt'] = $amt;
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->session->data['ppx']['amt'] = round($this->session->data['layaway_deposit'], 2);
				} elseif (isset($this->session->data['layaway_payment'])) {
					$this->session->data['ppx']['amt'] = round($this->session->data['layaway_payment']['amount'], 2);
					if ($this->config->get('layaway_payment_fee')) {
						$this->session->data['ppx']['amt'] += $this->config->get('layaway_payment_fee');
					}
				} else {
					$this->session->data['ppx']['amt'] = $amt;
				}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$oc_product_total = $this->cart->getSubTotal();
			]]></search>
			<add><![CDATA[
				if (!isset($this->session->data['layaway_deposit']) && !isset($this->session->data['layaway_payment'])) {
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				return $data;
			]]></search>
			<add><![CDATA[
				} else {
					if (isset($this->session->data['layaway_deposit'])) {
						$oc_product_total = round($this->session->data['layaway_deposit'], 2);
						$description = $this->config->get('layaway_button_name') . " Deposit";
						$price = $this->currency->format($this->session->data['layaway_deposit'], $currency, FALSE, FALSE);
					} else {
						if ($this->config->get('layaway_payment_fee')) {
							$oc_product_total = round($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), 2);
							$price = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $currency, FALSE, FALSE);
						} else {
							$oc_product_total = round($this->session->data['layaway_payment']['amount'], 2);
							$price = $this->currency->format($this->session->data['layaway_payment']['amount'], $currency, FALSE, FALSE);
						}
						$description = $this->config->get('layaway_button_name') . " Payment";
					}
					$i = 0;
					$pp_itemized_total = $price;
					$pp_product_total = $price;
					$data['L_NAME' . $i] 	= html_entity_decode($description, ENT_QUOTES, "ISO-8859-1");
					$data['L_NUMBER' . $i] 	= '';
					$data['L_DESC' . $i] 	= html_entity_decode($description, ENT_QUOTES, "ISO-8859-1");
					$data['L_AMT' . $i ] 	= $price;
					$data['L_QTY' . $i ] 	= 1;
					$pp_shipping_total = '0.00';
					$pp_tax_total = '0.00';
					$data['SHIPPINGAMT'] 	= $pp_shipping_total;
					$data['TAXAMT'] 		= $pp_tax_total;
					$pp_grand_total = round($pp_itemized_total + $pp_shipping_total + $pp_tax_total, 2);
					$data['ITEMAMT'] = round($pp_itemized_total, 2);
					$data['AMT'] = $pp_grand_total;
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/paystation.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				$amount = $this->currency->format($order_info['total'],$order_info['currency_code'], false, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$amount = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], false, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$amount = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], false, false);
					} else {
						$amount = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], false, false);
					}
				} else {
					$amount = $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/payment/payza.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['ap_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$this->data['ap_amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$this->data['ap_amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/perpetual_payments.php">
		<operation>
			<search position="after"><![CDATA[
				$order_info = $this->model_checkout_order->getOrder($this->session->data['order_id']);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$amount = $this->session->data['layaway_deposit'];
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$amount = $this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee');
					} else {
						$amount = $this->session->data['layaway_payment']['amount'];
					}
				} else {
					$amount = $order_info['total'];
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'tran_amount'    => $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false),
			]]></search>
			<add><![CDATA[
				'tran_amount'    => $this->currency->format($amount, $order_info['currency_code'], 1.00000, false),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/pp_express.php">
		<operation>
			<search position="after"><![CDATA[
				$order_info = $this->model_checkout_order->getOrder($this->session->data['order_id']);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$order_info['total'] = $this->session->data['layaway_deposit'];
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$order_info['total'] = $this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee');
					} else {
						$order_info['total'] = $this->session->data['layaway_payment']['amount'];
					}
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/pp_pro.php">
		<operation>
			<search position="replace"><![CDATA[
				$request .= '&AMT=' . $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], false, false);
				} elseif (isset($this->session->data['layaway_payment']['amount'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], false, false);
					} else {
						$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], false, false);
					}
				} else {
					$request .= '&AMT=' . $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/pp_pro_uk.php">
		<operation>
			<search position="replace"><![CDATA[
				$request .= '&AMT=' . $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], false, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], false, false);
					} else {
						$request .= '&AMT=' . $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], false, false);
					}
				} else {
					$request .= '&AMT=' . $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/pp_standard.php">
		<operation>
			<search position="after"><![CDATA[
				$this->load->model('checkout/order');
			]]></search>
			<add><![CDATA[
				if (!isset($this->session->data['order_id']) && isset($this->session->data['layaway_payment'])) {
					$this->session->data['order_id'] = $this->session->data['layaway_payment']['order_id'];
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->data['products'] = array();
			]]></search>
			<add><![CDATA[
				if (!isset($this->session->data['layaway_deposit']) && !isset($this->session->data['layaway_payment'])) {
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->data['discount_amount_cart'] = 0;
			]]></search>
			<add><![CDATA[
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$total = $this->currency->format($order_info['total'] - $this->cart->getSubTotal(), $order_info['currency_code'], false, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$total = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], false, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$total = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], false, false);
					} else {
						$total = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], false, false);
					}
				} else {
					$total = $this->currency->format($order_info['total'] - $this->cart->getSubTotal(), $order_info['currency_code'], false, false);
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				if ($total > 0) {
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$name = $this->config->get('layaway_button_name') . " Deposit";
				} elseif (isset($this->session->data['layaway_payment'])) {
					$name = $this->config->get('layaway_button_name') . " Payment";
				} else {
					$name = $this->language->get('text_total');
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'name'     => $this->language->get('text_total'),
			]]></search>
			<add><![CDATA[
				'name'     => $name,
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/sagepay.php">
		<operation>
			<search position="replace"><![CDATA[
				$data['Amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$data['Amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$data['Amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$data['Amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$data['Amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/sagepay_direct.php">
		<operation>
			<search position="replace"><![CDATA[
				$data['Amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$data['Amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], 1.00000, false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$data['Amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], 1.00000, false);
					} else {
						$data['Amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], 1.00000, false);
					}
				} else {
					$data['Amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/sagepay_us.php">
		<operation>
			<search position="replace"><![CDATA[
				$data .= '&T_amt=' . urlencode($this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false));
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$data .= '&T_amt=' . urlencode($this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], 1.00000, false));
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$data .= '&T_amt=' . urlencode($this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], 1.00000, false));
					} else {
						$data .= '&T_amt=' . urlencode($this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], 1.00000, false));
					}
				} else {
					$data .= '&T_amt=' . urlencode($this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false));
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/twocheckout.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['total'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['total'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['total'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$this->data['total'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$this->data['total'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/virtual_merchant.php" error="skip">
		<operation>
			<search position="replace"><![CDATA[
				$amount = $this->currency->format($order_info['total'], $order_info['currency'], FALSE, FALSE);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$amount = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency'], FALSE, FALSE);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$amount = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency'], FALSE, FALSE);
					} else {
						$amount = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency'], FALSE, FALSE);
					}
				} else {
					$amount = $this->currency->format($order_info['total'], $order_info['currency'], FALSE, FALSE);
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/payment/web_payment_software.php">
		<operation>
			<search position="replace"><![CDATA[
				$request .= '&AMOUNT=' . urlencode($this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false));
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$request .= '&AMOUNT=' . urlencode($this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], 1.00000, false));
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$request .= '&AMOUNT=' . urlencode($this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], 1.00000, false));
					} else {
						$request .= '&AMOUNT=' . urlencode($this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], 1.00000, false));
					}
				} else {
					$request .= '&AMOUNT=' . urlencode($this->currency->format($order_info['total'], $order_info['currency_code'], 1.00000, false));
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/payment/worldpay.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$this->data['amount'] = $this->currency->format($this->session->data['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value'], false);
				} elseif (isset($this->session->data['layaway_payment'])) {
					if ($this->config->get('layaway_payment_fee')) {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'] + $this->config->get('layaway_payment_fee'), $order_info['currency_code'], $order_info['currency_value'], false);
					} else {
						$this->data['amount'] = $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value'], false);
					}
				} else {
					$this->data['amount'] = $this->currency->format($order_info['total'], $order_info['currency_code'], $order_info['currency_value'], false);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/*/account/order.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['column_amount']					= 'Payment Amount';
				$_['column_description']			= 'Description';
				$_['column_balance']				= 'Remaining Balance';
				$_['text_layaway_payment_history']	= '%s Payment History';
				$_['text_layaway_deposit']			= '%s Deposit';
				$_['text_layaway_payment']			= '%s Payment';
				$_['entry_payment_amount']			= '%s Payment Amount: ';
				$_['button_payment']				= 'Make Payment';
				$_['error_payment_amount']			= 'Payment must be greater than 0 and less than or equal to your remaining balance!';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/*/checkout/checkout.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['text_layaway_deposit']			 = 'Initial %s Deposit';
				$_['entry_layaway_deposit']			 = 'Use %s?';
				$_['entry_layaway_amount']			 = '%s Deposit (Min: %s)';
				$_['error_amount_low']				 = 'The deposit amount must be equal to or greater than the required deposit of %s.';
				$_['error_amount_high']				 = 'The deposit cannot be greater than the order total of %s.';
				$_['error_below_minimum']			 = '<b>The order is below the mimimum amount of <font color="red">%s</font> for a %s order.  To use %s, your cart total must be above this amount. Click <a href="%s">here</a> to continue shopping.</b>';
				$_['error_not_registered']			 = 'In order to use %s, you must be a registered customer and logged into your account!';
				$_['text_payment_text']				 = 'Final payment is due by %s';
				$_['text_not_eligible']				 = 'This product is not eligible for %s';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/*/mail/order.php">
		<operation>
			<search position="after"><![CDATA[
				// Text
			]]></search>
			<add><![CDATA[
				$_['text_layaway_paid']			= '%s Paid Off';
				$_['text_layaway_paid_off']		= 'A %s order has been paid off.  The order id is %s';
				$_['text_layaway_payment']		= 'Thank you for your %s payment in the amount of %s.  Your remaining %s balance is %s';
				$_['text_layaway_payment_subject']	= 'Your %s payment confirmation for order id %s';
				$_['text_payment_text']				 = 'Final payment is due by %s';
				$_['text_not_eligible']				 = 'This product is not eligible for %s';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/account/order.php">
		<operation error="skip">
			<search position="before"><![CDATA[
				public function getTotalOrders() {
			]]></search>
			<add><![CDATA[
				public function getLayawayByOrderId($order_id) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "'");
					return $query->rows;
				}

				public function getCustomer($customer_id) {
					$query = $this->db->query("SELECT DISTINCT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "'");
					return $query->row;
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/checkout/order.php">
		<operation error="skip">
			<search position="replace"><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', shipping_code = '" . $this->db->escape($data['shipping_code']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', payment_code = '" . $this->db->escape($data['payment_code']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', forwarded_ip = '" .  $this->db->escape($data['forwarded_ip']) . "', user_agent = '" . $this->db->escape($data['user_agent']) . "', accept_language = '" . $this->db->escape($data['accept_language']) . "', date_added = NOW(), date_modified = NOW()");
			]]></search>
			<add><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', shipping_code = '" . $this->db->escape($data['shipping_code']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', payment_code = '" . $this->db->escape($data['payment_code']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', forwarded_ip = '" .  $this->db->escape($data['forwarded_ip']) . "', user_agent = '" . $this->db->escape($data['user_agent']) . "', accept_language = '" . $this->db->escape($data['accept_language']) . "', layaway_deposit = '" . (float)$data['layaway_deposit'] . "', date_added = NOW(), date_modified = NOW()");
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_company_id = '" . $this->db->escape($data['payment_company_id']) . "', payment_tax_id = '" . $this->db->escape($data['payment_tax_id']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', payment_code = '" . $this->db->escape($data['payment_code']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', shipping_code = '" . $this->db->escape($data['shipping_code']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', forwarded_ip = '" .  $this->db->escape($data['forwarded_ip']) . "', user_agent = '" . $this->db->escape($data['user_agent']) . "', accept_language = '" . $this->db->escape($data['accept_language']) . "', date_added = NOW(), date_modified = NOW()");
			]]></search>
			<add><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_company_id = '" . $this->db->escape($data['payment_company_id']) . "', payment_tax_id = '" . $this->db->escape($data['payment_tax_id']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', payment_code = '" . $this->db->escape($data['payment_code']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', shipping_code = '" . $this->db->escape($data['shipping_code']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', forwarded_ip = '" .  $this->db->escape($data['forwarded_ip']) . "', user_agent = '" . $this->db->escape($data['user_agent']) . "', accept_language = '" . $this->db->escape($data['accept_language']) . "', layaway_deposit = '" . (float)$data['layaway_deposit'] . "', date_added = NOW(), date_modified = NOW()");
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', reward = '" . (float)$data['reward'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', date_added = NOW(), date_modified = NOW()");
			]]></search>
			<add><![CDATA[
				$this->db->query("INSERT INTO `" . DB_PREFIX . "order` SET invoice_prefix = '" . $this->db->escape($data['invoice_prefix']) . "', store_id = '" . (int)$data['store_id'] . "', store_name = '" . $this->db->escape($data['store_name']) . "', store_url = '" . $this->db->escape($data['store_url']) . "', customer_id = '" . (int)$data['customer_id'] . "', customer_group_id = '" . (int)$data['customer_group_id'] . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', shipping_firstname = '" . $this->db->escape($data['shipping_firstname']) . "', shipping_lastname = '" . $this->db->escape($data['shipping_lastname']) . "', shipping_company = '" . $this->db->escape($data['shipping_company']) . "', shipping_address_1 = '" . $this->db->escape($data['shipping_address_1']) . "', shipping_address_2 = '" . $this->db->escape($data['shipping_address_2']) . "', shipping_city = '" . $this->db->escape($data['shipping_city']) . "', shipping_postcode = '" . $this->db->escape($data['shipping_postcode']) . "', shipping_country = '" . $this->db->escape($data['shipping_country']) . "', shipping_country_id = '" . (int)$data['shipping_country_id'] . "', shipping_zone = '" . $this->db->escape($data['shipping_zone']) . "', shipping_zone_id = '" . (int)$data['shipping_zone_id'] . "', shipping_address_format = '" . $this->db->escape($data['shipping_address_format']) . "', shipping_method = '" . $this->db->escape($data['shipping_method']) . "', payment_firstname = '" . $this->db->escape($data['payment_firstname']) . "', payment_lastname = '" . $this->db->escape($data['payment_lastname']) . "', payment_company = '" . $this->db->escape($data['payment_company']) . "', payment_address_1 = '" . $this->db->escape($data['payment_address_1']) . "', payment_address_2 = '" . $this->db->escape($data['payment_address_2']) . "', payment_city = '" . $this->db->escape($data['payment_city']) . "', payment_postcode = '" . $this->db->escape($data['payment_postcode']) . "', payment_country = '" . $this->db->escape($data['payment_country']) . "', payment_country_id = '" . (int)$data['payment_country_id'] . "', payment_zone = '" . $this->db->escape($data['payment_zone']) . "', payment_zone_id = '" . (int)$data['payment_zone_id'] . "', payment_address_format = '" . $this->db->escape($data['payment_address_format']) . "', payment_method = '" . $this->db->escape($data['payment_method']) . "', comment = '" . $this->db->escape($data['comment']) . "', total = '" . (float)$data['total'] . "', reward = '" . (float)$data['reward'] . "', affiliate_id = '" . (int)$data['affiliate_id'] . "', commission = '" . (float)$data['commission'] . "', language_id = '" . (int)$data['language_id'] . "', currency_id = '" . (int)$data['currency_id'] . "', currency_code = '" . $this->db->escape($data['currency_code']) . "', currency_value = '" . (float)$data['currency_value'] . "', ip = '" . $this->db->escape($data['ip']) . "', layaway_deposit = '" . (float)$data['layaway_deposit'] . "', date_added = NOW(), date_modified = NOW()");
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'date_added'              => $order_query->row['date_added']
			]]></search>
			<add><![CDATA[
				'date_added'              => $order_query->row['date_added'],
				'layaway_deposit'		  => $order_query->row['layaway_deposit']
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				if ($order_info && !$order_info['order_status_id']) {
			]]></search>
			<add><![CDATA[
				if ($order_info && !$order_info['order_status_id'] && !isset($this->session->data['layaway_payment'])) {
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$order_status_id . "', date_modified = NOW() WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_deposit'])) {
					$order_status_id = $this->config->get('layaway_order_status_id');
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$template->data['text_powered'] = $language->get('text_new_powered');
			]]></search>
			<add><![CDATA[
				$template->data['text_layaway_deposit'] = $this->config->get('layaway_button_name') . ' Deposit';
				$template->data['text_layaway_balance'] = $this->config->get('layaway_button_name') . ' Balance';
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$template->data['totals'] = $order_total_query->rows;
			]]></search>
			<add><![CDATA[
				if ($order_info['layaway_deposit'] > 0) {
					$balance = $order_info['total'] - $order_info['layaway_deposit'];
					$template->data['layaway_deposit'] = $this->currency->format($order_info['layaway_deposit'], $order_info['currency_code'], $order_info['currency_value']);
					$template->data['layaway_balance'] = $this->currency->format($balance, $order_info['currency_code'], $order_info['currency_value']);
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				public function update($order_id, $order_status_id, $comment = '', $notify = false) {
			]]></search>
			<add><![CDATA[
				public function getLayaway($order_id) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . $order_id . "'");
					if ($query->num_rows) {
						return $query->rows;
					} else {
						return;
					}
				}
				public function updateLayaway() {
					$this->load->language('mail/order');
					if (isset($this->session->data['order_id'])) {
						$order_info = $this->getOrder($this->session->data['order_id']);
					} elseif (isset($this->session->data['layaway_order_id'])) {
						$order_info = $this->getOrder($this->session->data['layaway_order_id']);
					}
					$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$this->config->get('layaway_order_status_id') . "' WHERE order_id = '" . (int)$order_info['order_id'] . "'");
					if (isset($this->session->data['layaway_deposit'])) {
						$date = time();
						$this->db->query("INSERT INTO " . DB_PREFIX . "order_layaway SET customer_id = '" . (int)$order_info['customer_id'] . "', order_id = '" . (int)$order_info['order_id'] . "', deposit = '" . (float)$this->session->data['layaway_deposit'] . "', date_added = '" . $date . "'");
					} else {
						$add_payment = array();
						$balance = 0;
						$layaway = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_info['order_id'] . "'");
						foreach ($layaway->rows as $row) {
							if (isset($this->session->data['selected_currency'])) {
								$balance = round($order_info['total'] - $row['deposit'], $this->session->data['selected_currency']['decimal']);
							} elseif (isset($this->session->data['store_id'])) {
								$currency_data = $this->model_localisation_currency->getCurrencyByCode($this->session->data['store_config']['config_currency']);
								$balance = round($order_info['total'] - $row['deposit'], $currency_data['decimal_place']);
							} else {
								$currency_data = $this->model_localisation_currency->getCurrencyByCode($this->config->get('config_currency'));
								$balance = round($order_info['total'] - $row['deposit'], $currency_data['decimal_place']);
							}
							if (!empty($row['payments'])) {
								foreach (unserialize($row['payments']) as $payment) {
									$add_payment[] = array(
										'payment_date'			=> $payment['payment_date'],
										'payment_description'	=> $this->config->get('layaway_button_name') . ' Payment',
										'payment_amount'		=> $payment['payment_amount']
									);
									$balance -= $payment['payment_amount'];
								}
							}
						}
						$date = time();
						$add_payment[] = array(
							'payment_date'			=> $date,
							'payment_description'	=> $this->config->get('layaway_button_name') . ' Payment',
							'payment_amount'		=> $this->session->data['layaway_payment']['amount']
						);
						$balance -= $this->session->data['layaway_payment']['amount'];
						$this->db->query("UPDATE " . DB_PREFIX . "order_layaway SET payments = '" . $this->db->escape(serialize($add_payment)) . "' WHERE order_id = '" . (int)$order_info['order_id'] . "'");
						$subject = sprintf($this->language->get('text_layaway_payment_subject'), $this->config->get('layaway_button_name'), $order_info['order_id']);
						$message = sprintf($this->language->get('text_layaway_payment'), $this->config->get('layaway_button_name'),  $this->currency->format($this->session->data['layaway_payment']['amount'], $order_info['currency_code'], $order_info['currency_value']), $this->config->get('layaway_button_name'), $this->currency->format($balance, $order_info['currency_code'], $order_info['currency_value']));
						$mail = new Mail(); 
						$mail->protocol = $this->config->get('config_mail_protocol');
						$mail->parameter = $this->config->get('config_mail_parameter');
						$mail->hostname = $this->config->get('config_smtp_host');
						$mail->username = $this->config->get('config_smtp_username');
						$mail->password = $this->config->get('config_smtp_password');
						$mail->port = $this->config->get('config_smtp_port');
						$mail->timeout = $this->config->get('config_smtp_timeout');			
						$mail->setTo($order_info['email']);
						$mail->setFrom($this->config->get('config_email'));
						$mail->setSender($order_info['store_name']);
						$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
						$mail->setHtml($message);
						$mail->setText(html_entity_decode($message, ENT_QUOTES, 'UTF-8'));
						$mail->send();
						if (number_format($balance, 2, ".", "") == 0.00) {
							$subject = sprintf($this->language->get('text_layaway_paid_off'), $this->config->get('layaway_button_name'), $order_info['order_id']);
							$mail = new Mail(); 
							$mail->protocol = $this->config->get('config_mail_protocol');
							$mail->parameter = $this->config->get('config_mail_parameter');
							$mail->hostname = $this->config->get('config_smtp_host');
							$mail->username = $this->config->get('config_smtp_username');
							$mail->password = $this->config->get('config_smtp_password');
							$mail->port = $this->config->get('config_smtp_port');
							$mail->timeout = $this->config->get('config_smtp_timeout');			
							$mail->setTo($this->config->get('config_email'));
							$mail->setFrom($this->config->get('config_email'));
							$mail->setSender($order_info['store_name']);
							$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
							$mail->setHtml($subject);
							$mail->setText(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
							$mail->send();
						}
					}
					unset($this->session->data['layaway_order_id']);
					return;
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				if ($order_info && $order_info['order_status_id']) {
			]]></search>
			<add><![CDATA[
				if ($order_info && $order_info['order_status_id'] && !isset($this->session->data['layaway_payment'])) {
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1"><![CDATA[
				foreach ($order_product_query->rows as $product) {
			]]></search>
			<add><![CDATA[
				$payment_text = '';
				if (isset($this->session->data['layaway_deposit'])) {
					$product_query = $this->db->query("SELECT payment_due FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$product['product_id'] . "'");
					if ($product_query->row['payment_due']) {
						if ($product_query->row['payment_due'] > time()) {
							$payment_text = sprintf($language->get('text_payment_text'), date($language->get('date_format_short'), $date_query->row['payment_due']));
						} else {
							$payment_text = sprintf($language->get('text_not_eligible'), $this->config->get('layaway_button_name'));
						}
					} else {
						$due_date = strtotime('Today + ' . $this->config->get('layaway_timeframe') . ' days');
						$payment_text = sprintf($language->get('text_payment_text'), date($language->get('date_format_short'), $due_date));
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				=> $product['name'],
			]]></search>
			<add><![CDATA[
				'payment_text'	=> $payment_text,
			]]></add>
		</operation>
	</file>

	<file name="catalog/model/total/total.php">
		<operation>
			<search position="before"><![CDATA[
				$total_data[] = array(
			]]></search>
			<add><![CDATA[
				if (isset($this->session->data['layaway_payment']) && !isset($this->session->data['customer_info'])) {
					$total_data[] = array(
						'code'		 => 'layaway_fee',
						'title'		 => $this->config->get('layaway_button_name') . ' Payment Fee',
						'text'		 => $this->currency->format($this->config->get('layaway_payment_fee')),
						'value'		 => $this->config->get('layaway_payment_fee'),
						'sort_order' => $this->config->get('total_sort_order') - 1
					);
					$total += $this->config->get('layaway_payment_fee');
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/account/order_info.tpl">
		<operation>
			<search position="before"><![CDATA[
				<?php if ($histories) { ?>
			]]></search>
			<add><![CDATA[
				<?php if ($layaways) { ?>
					<h2><?php echo $text_layaway_payment_history; ?></h2>
					<form action="<?php echo $action; ?>" method="post" enctype="multipart/form-data" id="form">
					<table class="list">
						<thead>
							<tr>
								<td class="left"><?php echo $column_description; ?></td>
								<td class="left"><?php echo $column_date_added; ?></td>
								<td class="right"><?php echo $column_amount; ?></td>
								<td class="right"><?php echo $column_balance; ?></td>
							</tr>
						</thead>
						<tbody>
							<?php foreach ($layaways as $layaway) { ?>
								<tr>
									<td class="left"><?php echo $layaway['description']; ?></td>
									<td class="left"><?php echo $layaway['date_added']; ?></td>
									<td class="right"><?php echo $layaway['amount']; ?></td>
									<td class="right"><font color="#2755bb"><?php echo $layaway['balance']; ?></font></td>
								</tr>
							<?php } ?>
							<?php if ($balance > 0) { ?>
							  <tr>
								<td class="right" colspan="3"><?php echo $entry_payment_amount; ?><input style="margin-left: 5px;" type="text" name="payment_amount" value="" size="8" /></td>
								<td class="center"><a id="make_payment" class="button"><span><?php echo $button_payment; ?></span></a></td>
							  </tr>
							<?php } ?>
						</tbody>
					</table>
					</form>
				<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				<?php echo $footer; ?> 
			]]></search>
			<add><![CDATA[
				<?php if ($layaways) { ?>
					<script type="text/javascript">
						$(document).ready(function() {
							$('#make_payment').live('click', function() {
								if (parseFloat($('input[name=\'payment_amount\']').val()) > parseFloat('<?php echo $balance; ?>') || parseFloat($('input[name=\'payment_amount\']').val()) <= 0 || $('input[name=\'payment_amount\']').val() == '') {
									alert('<?php echo $error_payment_amount; ?>');
									$('input[name=\'payment_amount\']').val('');
									$('input[name=\'payment_amount\']').focus();
									return false;
								} else {
									$('#form').submit();
								}
							});
						});
					</script>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/checkout/cart.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				<td class="quantity"><input type="text" name="" value="1" size="1" disabled="disabled" />
			]]></search>
			<add><![CDATA[
				<?php if (isset($this->session->data['layaway_payment'])) { ?>
				  <td class="quantity">1
				<?php } else { ?>
				  <td class="quantity"><input type="text" name="" value="1" size="1" disabled="disabled" />
				<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				<div class="center"><a href="<?php echo $continue; ?>" class="button"><?php echo $button_shopping; ?></a></div>
			]]></search>
			<add><![CDATA[
				<?php if (!isset($this->session->data['layaway_payment'])) { ?>
				  <div class="center"><a href="<?php echo $continue; ?>" class="button"><?php echo $button_shopping; ?></a></div>
				<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				<td class="quantity"><input type="text" name="quantity[<?php echo $product['key']; ?>]" value="<?php echo $product['quantity']; ?>" size="3" /></td>
			]]></search>
			<add><![CDATA[
				<?php if (isset($this->session->data['layaway_payment'])) { ?>
				  <td class="quantity">1
				<?php } else { ?>
				  <td class="quantity"><input type="text" name="" value="1" size="1" disabled="disabled" />
				<?php } ?>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				<div class="center"><a href="<?php echo $continue; ?>" class="button"><span><?php echo $button_shopping; ?></span></a></div>
			]]></search>
			<add><![CDATA[
				<?php if (!isset($this->session->data['layaway_payment'])) { ?>
				  <div class="center"><a href="<?php echo $continue; ?>" class="button"><span><?php echo $button_shopping; ?></span></a></div>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/checkout/checkout.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				data: $('#payment-method input[type=\'radio\']:checked, #payment-method input[type=\'checkbox\']:checked, #payment-method textarea'),
			]]></search>
			<add><![CDATA[
				data: $('#payment-method input[type=\'radio\']:checked, #payment-method input[type=\'checkbox\']:checked, #payment-method input[type=\'text\'], #payment-method textarea'),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/checkout/confirm.tpl">
		<operation>
			<search position="replace" index="2"><![CDATA[
				<td class="name">
			]]></search>
			<add><![CDATA[
				<td class="name">
					<?php if ($product['payment_text']) { ?>
						<span class="required"><?php echo $product['payment_text']; ?></span><br />
					<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
				</tbody>
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
				<td class="total"><?php echo $total['text']; ?></td>
			]]></search>
			<add><![CDATA[
					<td class="total"><?php echo $total['text']; ?></td>
				  </tr>
				  <?php } ?>
				</tbody>
				<tfoot>
				  <?php if(isset($layaway_deposit)) { ?>
					<tr>
					  <td colspan="4" class="price"><b><?php echo $text_layaway_deposit; ?>:</b></td>
					  <td class="total"><?php echo $layaway_deposit; ?></td>
					</tr>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/*/template/checkout/payment_method.tpl" error="skip">
		<operation>
			<search position="before" index="1"><![CDATA[
				</table>
			]]></search>
			<add><![CDATA[
			  <?php if (isset($layaway_is_active) && !isset($below_minimum)) { ?>
				<tr id="layaway_deposit_box" class="highlight">
				  <?php if (isset($layaway_cart) && !isset($need_to_register)) { ?>
				    <td><input type="checkbox" checked="checked" disabled="disabled" name="layaway_deposit" id="layaway_deposit" onclick="return layaway_deposit();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
				  <?php } else { ?>
					<?php if (!isset($need_to_register)) { ?>
				      <td><input type="checkbox" name="layaway_deposit" id="layaway_deposit" onclick="return layaway_deposit();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
					<?php } else { ?>
					  <td><input type="checkbox" name="layaway_deposit" id="layaway_deposit" onclick="layaway_message();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
					<?php } ?>
				  <?php } ?>
				</tr>
				<?php if (isset($layaway_cart) && !isset($need_to_register)) { ?>
				  <tr id="layaway_deposit_checkout">
				<?php } else { ?>
				  <tr id="layaway_deposit_checkout" style="display:none;">
				<?php } ?>
				  <td colspan="2">
					<?php echo $entry_layaway_amount; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<input style="text-align: right;" id="layaway_amount" type="text" name="layaway_amount" value="<?php echo $required_deposit; ?>" size="8" />
					<input type="hidden" name="required_layaway" value="<?php echo $required_deposit; ?>" />
					<input type="hidden" name="order_total" value="<?php echo $order_total; ?>" />
				  </td>
				</tr>
			  <?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				<input type="button" value="<?php echo $button_continue; ?>" id="button-payment-method" class="button" />
			]]></search>
			<add><![CDATA[
				<input type="button" value="<?php echo $button_continue; ?>" id="button-payment-method" class="button" onclick="$('#layaway_deposit').attr('disabled', false);" />
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				//--></script> 
			]]></search>
			<add><![CDATA[
				<script type="text/javascript"><!--
					function layaway_deposit(){
						var satisfied = $('#layaway_deposit:checked').val();
						if ($('#layaway_deposit').is(':checked')) {
							$('#layaway_deposit_checkout').show();
							$('#installment_box').hide();
						} else {
							$('#layaway_deposit_checkout').hide();
							$('#installment_box').show();
						}
					}
						
					$(document).ready(function() {
						<?php if (isset($layaway_is_active) && !isset($below_minimum)) { ?>
							$('#layaway_amount').live('change', function() {
								if (parseFloat($('#layaway_amount').val()) < parseFloat($('input[name=\'required_layaway\']').val())) {
									alert('<?php echo $error_amount_low; ?>');
									$('#layaway_amount').val($('input[name=\'required_layaway\']').val());
									return false;
								} else if (parseFloat($('#layaway_amount').val()) > parseFloat($('input[name=\'order_total\']').val())) {
									alert('<?php echo $error_amount_high; ?>');
									$('#layaway_amount').val($('input[name=\'required_layaway\']').val());
									return false;
								}
							});
						<?php } elseif (isset($layaway_cart) && isset($below_minimum)) { ?>
							$('#button-payment-method').hide();
							$('#button-payment').hide();
							$('.buttons').html('<?php echo $below_minimum_msg; ?>');
						<?php } ?>
					});
					
					function layaway_message() {
						alert('<?php echo $error_not_registered; ?>');
						$('#layaway_deposit').attr('checked', false);
						return;
					}
				//--></script>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/checkout/payment.tpl" error="skip">
		<operation>
			<search position="before" index="1"><![CDATA[
				</table>
			]]></search>
			<add><![CDATA[
			  <?php if (isset($layaway_is_active) && !isset($below_minimum)) { ?>
				<tr id="layaway_deposit_box" class="highlight">
				  <?php if (isset($layaway_cart) && !isset($need_to_register)) { ?>
				    <td><input type="checkbox" checked="checked" disabled="disabled" name="layaway_deposit" id="layaway_deposit" onclick="return layaway_deposit();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
				  <?php } else { ?>
					<?php if (!isset($need_to_register)) { ?>
				      <td><input type="checkbox" name="layaway_deposit" id="layaway_deposit" onclick="return layaway_deposit();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
					<?php } else { ?>
					  <td><input type="checkbox" name="layaway_deposit" id="layaway_deposit" onclick="layaway_message();" /></td><td><?php echo $entry_layaway_deposit; ?></td>
					<?php } ?>
				  <?php } ?>
				</tr>
				<?php if (isset($layaway_cart) && !isset($need_to_register)) { ?>
				  <tr id="layaway_deposit_checkout">
				<?php } else { ?>
				  <tr id="layaway_deposit_checkout" style="display:none;">
				<?php } ?>
				  <td colspan="2">
					<?php echo $entry_layaway_amount; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<input style="text-align: right;" id="layaway_amount" type="text" name="layaway_amount" value="<?php echo $required_deposit; ?>" size="8" />
					<input type="hidden" name="required_layaway" value="<?php echo $required_deposit; ?>" />
					<input type="hidden" name="order_total" value="<?php echo $order_total; ?>" />
				  </td>
				</tr>
			  <?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				//--></script> 
			]]></search>
			<add><![CDATA[
				<script type="text/javascript"><!--
					function layaway_deposit(){
						var satisfied = $('#layaway_deposit:checked').val();
						if ($('#layaway_deposit').is(':checked')) {
							$('#layaway_deposit_checkout').show();
							$('#installment_box').hide();
						} else {
							$('#layaway_deposit_checkout').hide();
							$('#installment_box').show();
						}
					}
						
					$(document).ready(function() {
						<?php if (isset($layaway_is_active) && !isset($below_minimum)) { ?>
							$('#button-payment').live('click', function() {
								$('#layaway_deposit').attr('disabled', false);
							});
							$('#layaway_amount').live('change', function() {
								if (parseFloat($('#layaway_amount').val()) < parseFloat($('input[name=\'required_layaway\']').val())) {
									alert('<?php echo $error_amount_low; ?>');
									$('#layaway_amount').val($('input[name=\'required_layaway\']').val());
									return false;
								} else if (parseFloat($('#layaway_amount').val()) > parseFloat($('input[name=\'order_total\']').val())) {
									alert('<?php echo $error_amount_high; ?>');
									$('#layaway_amount').val($('input[name=\'required_layaway\']').val());
									return false;
								}
							});
						<?php } elseif (isset($layaway_cart) && isset($below_minimum)) { ?>
							$('#button-payment').hide();
							$('.buttons').html('<?php echo $below_minimum_msg; ?>');
						<?php } ?>
					});
					
					function layaway_message() {
						alert('<?php echo $error_not_registered; ?>');
						$('#layaway_deposit').attr('checked', false);
						return;
					}
				//--></script>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/*/template/mail/order.tpl">
		<operation>
			<search position="replace"><![CDATA[
				<?php echo $product['name']; ?>
			]]></search>
			<add><![CDATA[
				<?php if ($product['payment_text']) { ?>
					<span style="color: red; font-weight: bold;"><?php echo $product['payment_text']; ?></span><br />
				<?php } ?><?php echo $product['name']; ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				</tfoot>
			]]></search>
			<add><![CDATA[
				<?php if (isset($layaway_deposit)) { ?>
					<tr>
						<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b><?php echo $text_layaway_deposit; ?>:</b></td>
						<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;"><?php echo $layaway_deposit; ?></td>
					</tr>
					<tr>
						<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b><?php echo $text_layaway_balance; ?>:</b></td>
						<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;"><?php echo $layaway_balance; ?></td>
					</tr>
				<?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="system/library/cart.php">
		<operation error="skip">
			<search position="after"><![CDATA[
				public function add($product_id, $qty = 1, $options = array()) {
			]]></search>
			<add><![CDATA[
				unset($this->session->data['layaway_deposit']);
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				public function add($product_id, $qty = 1, $option = array()) {
			]]></search>
			<add><![CDATA[
				unset($this->session->data['layaway_deposit']);
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				public function update($key, $qty) {
			]]></search>
			<add><![CDATA[
				unset($this->session->data['layaway_deposit']);
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				public function remove($key) {
			]]></search>
			<add><![CDATA[
				unset($this->session->data['layaway_deposit']);
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				if ($product_query->num_rows) {
			]]></search>
			<add><![CDATA[
				$layaway_product = 1;
				if ($product_query->row['payment_due'] && $product_query->row['payment_due'] < time()) {
					$layaway_product = 0;
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				=> $product_query->row['product_id'],
			]]></search>
			<add><![CDATA[
				'payment_due'		=> $product_query->row['payment_due'],
				'layaway_product'	=> $layaway_product,
			]]></add>
		</operation>
	</file>
	
</modification>