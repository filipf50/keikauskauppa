<modification>
	<id>HTML Email Template: Admin</id>
	<version>4.5.1.7</version>
	<vqmver>2.4.0</vqmver>
	<author>opencart-templates.co.uk</author>
		
	<file name="admin/controller/sale/order.php">
        <operation>
            <search position="after"><![CDATA[
            $this->data['entry_notify'] = $this->language->get('entry_notify'); ]]></search>
            <add><![CDATA[
            $this->data['entry_summary'] = $this->language->get('entry_summary');
            $this->data['entry_show_products'] = $this->language->get('entry_show_products');
            $this->data['entry_show_totals'] = $this->language->get('entry_show_totals');
            $this->data['entry_show_downloads'] = $this->language->get('entry_show_downloads');
            $this->data['entry_show_vouchers'] = $this->language->get('entry_show_vouchers');
            $this->data['entry_template'] = $this->language->get('entry_template');
            $this->data['entry_pdf_attach'] = $this->language->get('entry_pdf_attach');
            
			$this->load->model('module/emailtemplate');
            $this->data['templates'] = $this->model_module_emailtemplate->getTemplates(array('type' => 'order_status', 'language_id' => $order_info['language_id']));            
            $this->data['templates_action'] = $this->url->link('module/emailtemplate/fetch_template', 'token='.$this->session->data['token'], 'SSL'); ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            nl2br($result['comment']) ]]></search>
            <add trim="true"><![CDATA[
            (strcmp($result['comment'], strip_tags($html_str = html_entity_decode($result['comment'], ENT_QUOTES, 'UTF-8'))) == 0) ? nl2br($result['comment']) : $html_str ]]></add>
        </operation>
        <operation>
            <search error="skip" position="replace"><![CDATA[
            nl2br($order_info['comment']) ]]></search>
            <add trim="true"><![CDATA[
            (strcmp($order_info['comment'], strip_tags($html_str = html_entity_decode($order_info['comment'], ENT_QUOTES, 'UTF-8'))) == 0) ? nl2br($order_info['comment']) : $html_str ]]></add>
        </operation>
    </file>
		
	<file name="admin/view/template/sale/order_info.tpl">
        <operation>
            <search position="after"><![CDATA[
            $('.vtabs a').tabs(); ]]></search>
            <add><![CDATA[//--></script> 			
            <script type="text/javascript" src="view/javascript/ckeditor/ckeditor.js"></script>
			<script type="text/javascript"><!--
			// Order history show/hide summary options
			(function($){
				function showEmailOptions($row, $checkbox){
					if($checkbox.is(':checked')) { 
						$row.show(); 
					} else { 
						$row.hide(); 
					}
				}				
				$(document).ready(function() {
					$('input[name=notify]').eq(0).each(function(){
						showEmailOptions($('.emailOptions'), $(this));
					}).change(function(){
						showEmailOptions($('.emailOptions'), $(this));
					});
					$('select#field_templates').change(function(){
						if (!confirm("Are you sure you want to change the template? This will clear all of the text inside the editor")) return;
						var val = $(this).val();
						if(val){
						$.ajax({
				            url: '<?php echo html_entity_decode($templates_action); ?>',
				            type: 'post',
				            dataType: 'html',
				            data: 'id=' + val + '&order_id=<?php echo $order_id; ?>',
				            success: function(html) {
				                 $('textarea[name=comment]').val(html);  
				                 CKEDITOR.instances['comment'].setData(html);  
				            },
				            error: function(xhr, ajaxOptions, thrownError) {
			                    console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			                    alert('Error. More details in console.');
				            }
				   		});
				   		}	
					});
				});	
			})(jQuery);		
			
			CKEDITOR.replace('comment', {
				filebrowserImageBrowseUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
				filebrowserUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
				filebrowserImageUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>'
			}); ]]></add>
        </operation>
        <operation info="Add checkboxes into ajax post data">
            <search position="replace"><![CDATA[
            + '&notify=' ]]></search>
            <add trim="true"><![CDATA[
            <?php if(!empty($products)){ ?>+ ($('input[name=\'show_products\']').attr('checked') ? '&show_products=1' : '')<?php }
            if(!empty($downloads)){ ?>+ ($('input[name=\'show_downloads\']').attr('checked') ? '&show_downloads=1' : '')<?php }
            if(!empty($vouchers)){ ?>+ ($('input[name=\'show_vouchers\']').attr('checked') ? '&show_vouchers=1' : '')<?php } 
            if(!empty($totals)){ ?>+ ($('input[name=\'show_totals\']').attr('checked') ? '&show_totals=1' : '')<?php } ?>
            + ($('input[name=\'attach_pdf\']').attr('checked') ? '&attach_pdf=1' : '') + '&notify=' ]]></add>
        </operation>
        <operation error="skip">
            <search position="after"><![CDATA[
            $('#button-history').live('click', function() { ]]></search>
            <add><![CDATA[
            // Force CKEDITOR instance in the form to update their respective fields
            CKEDITOR.instances.comment.updateElement(); ]]></add>
        </operation>
        <operation error="skip"><!-- old versions of OC -->
            <search position="after"><![CDATA[
            function history() { ]]></search>
            <add><![CDATA[
            // Force CKEDITOR instance in the form to update their respective fields
            CKEDITOR.instances.comment.updateElement(); ]]></add>
        </operation>
        <operation error="skip">
            <search position="before"><![CDATA[
            $('textarea[name=\'comment\']').val(''); ]]></search>
            <add><![CDATA[
            // Clear CKEDITOR data
            CKEDITOR.instances.comment.setData('');
            
            $('#tab-history .form').each(function(){
            	$(this).find('input[type=checkbox], input[type=radio]').removeAttr('checked');
            	$(this).find('select > option').removeAttr('selected');
            	$(this).find('.emailOptions').hide();
            }); ]]></add>
        </operation>
        <operation info="Add order summary option">
            <search position="after"><![CDATA[
            <td><input type="checkbox" name="notify" value="1" /></td> ]]></search>
            <add><![CDATA[
          </tr>
          <tr class="emailOptions" style="display: none">
            <td><?php echo $entry_summary; ?></td>
            <td>
            	<?php if(!empty($products)){ ?>
            		<label><input type="checkbox" name="show_products" value="1" style="vertical-align: middle;" /> <?php echo $entry_show_products; ?></label><br />
           		<?php } ?>
            	<?php if(!empty($totals)){ ?>
            		<hr style="border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none;" />
            		<label><input type="checkbox" name="show_totals" value="1" style="vertical-align: middle;" /> <?php echo $entry_show_totals; ?></label><br />
           		<?php } ?>
	         	<?php if(!empty($downloads)){ ?>
	         		<hr style="border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none;" />
	         		<label><input type="checkbox" name="show_downloads" value="1" style="vertical-align: middle;" /> <?php echo $entry_show_downloads; ?></label><br />
         		<?php } ?>
	         	<?php if(!empty($vouchers)){ ?>
	         		<hr style="border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none;" />
	         		<label><input type="checkbox" name="show_vouchers" value="1" style="vertical-align: middle;" /> <?php echo $entry_show_vouchers; ?></label>
         		<?php } ?>
          </tr>
          <tr class="emailOptions" style="display: none">
            <td><?php echo $entry_pdf_attach; ?></td>
            <td>
         		<label><input type="checkbox" name="attach_pdf" value="1" style="vertical-align: middle;" /></label>
          </tr>
          <tr class="emailOptions" style="display: none">
            <td><?php echo $entry_template; ?></td>
            <td>
            	<select id="field_templates">
	            	<option></option>
	            	<?php foreach($templates as $_template){ ?>
	            		<option value="<?php echo $_template['id']; ?>"><?php echo $_template['name'].' - '.$_template['language_code']; ?></option>
	            	<?php } ?>
            	</select> ]]></add>
        </operation>
	</file>
	
	<file name="admin/model/sale/order.php">
        <operation>
            <search position="after"><![CDATA[
            if ($data['notify']) ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry, $order_info['language_id']);
            $template->tracking('sale/order');
                           
            // Products
            $template->data['products'] = array();  
            if(isset($data['show_products'])){ 
            	$this->load->model('tool/image');  
				$products = $this->model_sale_order->getOrderProducts($this->request->get['order_id']);	
				foreach ($products as $product) {
				
					// Product Options
					$option_data = array();	
					$options = $this->model_sale_order->getOrderOptions($this->request->get['order_id'], $product['order_product_id']);	
					foreach ($options as $option) {
						if ($option['type'] != 'file') {
							$option_data[] = array(
								'name'  => $option['name'],
								'value' => $option['value'],
								'type'  => $option['type']
							);
						} else {
							$option_data[] = array(
								'name'  => $option['name'],
								'value' => utf8_substr($option['value'], 0, utf8_strrpos($option['value'], '.')),
								'type'  => $option['type'],
								'href'  => $this->url->link('sale/order/download', 'token=' . $this->session->data['token'] . '&order_id=' . $this->request->get['order_id'] . '&order_option_id=' . $option['order_option_id'], 'SSL')
							);						
						}
					}
					
					// Image
					if (isset($product['image']) && $template->getConfig('emailtemplate_order_picture')) {
						$image = $this->model_tool_image->resize($product['image'], 50, 50);
					} else {
						$image = '';
					}
	
					$template->data['products'][] = array(
						'order_product_id' => $product['order_product_id'],
						'product_id'       => $product['product_id'],
						'name'    	 	   => $product['name'],
						'model'    		   => $product['model'],
						'image'    		   => $image,
						'option'   		   => $option_data,
						'quantity'		   => $product['quantity'],
						'price'    		   => $this->currency->format($product['price'] + ($this->config->get('config_tax') ? $product['tax'] : 0), $order_info['currency_code'], $order_info['currency_value']),
						'total'    		   => $this->currency->format($product['total'] + ($this->config->get('config_tax') ? ($product['tax'] * $product['quantity']) : 0), $order_info['currency_code'], $order_info['currency_value']),
						'href'     		   => $this->url->link('catalog/product/update', 'token=' . $this->session->data['token'] . '&product_id=' . $product['product_id'], 'SSL')
					);
				}
			}
			
			// Vouchers
			$template->data['vouchers'] = array();
			if(isset($data['show_vouchers'])){
				$vouchers = $this->model_sale_order->getOrderVouchers($this->request->get['order_id']);			 
				foreach ($vouchers as $voucher) {
					$template->data['vouchers'][] = array(
						'description' => $voucher['description'],
						'amount'      => $this->currency->format($voucher['amount'], $order_info['currency_code'], $order_info['currency_value']),
						'href'        => $this->url->link('sale/voucher/update', 'token=' . $this->session->data['token'] . '&voucher_id=' . $voucher['voucher_id'], 'SSL')
					);
				}
			}
			
			// Totals
			$template->data['totals'] = array();
			if(isset($data['show_totals'])){
				$template->data['totals'] = $this->model_sale_order->getOrderTotals($this->request->get['order_id']);
			}
	
			// Downloads
			$template->data['downloads'] = array();
			if(isset($data['show_downloads'])){				
				foreach ($products as $product) {
					$results = $this->model_sale_order->getOrderDownloads($this->request->get['order_id'], $product['order_product_id']);	
					foreach ($results as $result) {
						$template->data['downloads'][] = array(
							'name'      => $result['name'],
							'filename'  => $result['mask'],
							'remaining' => $result['remaining']
						);
					}
				}
			}	
			
			// Invoice Attachment
			$attachments = array();
			if(isset($data['attach_pdf'])){
				$this->load->model('module/emailtemplate/invoice');
				$attachments[] = $this->model_module_emailtemplate_invoice->getInvoice($this->request->get['order_id']);
			} ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            $message .= $language->get('text_footer'); ]]></search>
            <add><![CDATA[  
            if (!empty($template->data['products'])) {
            	$message .= "\n" . $language->get('text_new_products') . "\n"; 
	            foreach ($template->data['products'] as $product) {
	                $message .= $product['quantity'] . 'x ' . $product['name'] . ' (' . $product['model'] . ') ' . html_entity_decode($product['total'], ENT_NOQUOTES, 'UTF-8') . "\n";
	                foreach ($product['option'] as $option) {
	                    $message .= chr(9) . '-' . $option['name'] . ' ' . (utf8_strlen($option['value']) > 20 ? utf8_substr($option['value'], 0, 20) . '..' : $option['value']) . "\n";
	                }
            	}
            }

	        if (!empty($template->data['vouchers'])) { 
	            foreach ($template->data['vouchers'] as $voucher) {
	                $message .= '1x ' . $voucher['description'] . ' ' . $this->currency->format($voucher['amount'], $order_info['currency_code'], $order_info['currency_value']);
	            }
            }
            
			if (!empty($template->data['totals'])) {
	            $message .= "\n" . $language->get('text_total') . "\n";	
	            foreach ($template->data['totals'] as $total) {
	                $message .= $total['title'] . ': ' . html_entity_decode($total['text'], ENT_NOQUOTES, 'UTF-8') . "\n";
	            }
            }
               
            if (!empty($template->data['downloads'])) {
                $message .= "\n" . $language->get('text_download') . "\n";
                $message .= $order_info['store_url'] . 'index.php?route=account/download' . "\n\n";
            }
                   
			// Overwrite config with store data
			$this->load->model('setting/setting');
			$this->load->model('setting/store');
			$store_info = $this->model_setting_store->getStore($order_info['store_id']);
			$store_settings_config = $this->model_setting_setting->getSetting("config", $order_info['store_id']);
			$template->populateStoreData(array_merge($store_settings_config, $store_info, $order_info));
			
			// Overwrite config with email data
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $order_info['store_id']);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');            
            $template->setTitle($subject);
            		
			$template->appendDataLanguage($language, array(
            	'text_order',
            	'text_date_added',
            	'text_order_status',
            	'text_link' =>'text_invoice',
            	'text_comment',
            	'text_footer',
            	'text_product',
            	'text_download',
            	'text_total',
            	'text_model',
            	'text_price'
            ));
                        			
			$template->appendData(array(
				'comment' => html_entity_decode($data['comment'], ENT_QUOTES, 'UTF-8'),
				'date_added' => date($language->get('date_format_short'), strtotime($order_info['date_added'])),
				'invoice' => html_entity_decode($order_info['store_url'] . 'index.php?route=account/order/info&order_id=' . $order_id, ENT_QUOTES, 'UTF-8'),
				'order_id' => $order_id,
				'customer_id' => $order_info['customer_id'],
				'order_status' => $order_status_query->row['name'],
				'show_downloads' => (isset($data['show_downloads'])) ? $data['show_downloads'] : '',
				'show_totals' => (isset($data['show_totals'])) ? $data['show_totals'] : '',
				'show_products' => (isset($data['show_products'])) ? $data['show_products'] : '',
				'show_vouchers' => (isset($data['show_vouchers'])) ? $data['show_vouchers'] : ''
			));
			
			$html = $template->fetch('order_update.tpl', '_mail.tpl'); ]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[
            $mail->setFrom($this->config->get('config_email')); ]]></search>
            <add><![CDATA[
            $mail->setFrom($store_settings_config['config_email']); ]]></add>
        </operation>
        <operation>
            <search position="before"><![CDATA[
            $mail->send(); ]]></search>
            <add><![CDATA[
            $mail->setHTML($html);
            foreach($attachments as $attachment){
            	$mail->addAttachment($attachment);
            } ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            comment = '" . $this->db->escape(strip_tags($data['comment'])) . "' ]]></search>
            <add trim="true"><![CDATA[
            comment = '" . $this->db->escape($data['comment']) . "' ]]></add>
        </operation>
        <operation>
            <search position="before"><![CDATA[
            'payment_firstname'       => $order_query->row['payment_firstname'], ]]></search>
            <add><![CDATA[
            'invoice_filename'     => $order_query->row['invoice_filename'], ]]></add>
        </operation>
	</file>
	
	<file name="admin/controller/sale/contact.php">
        <operation>
            <search position="after"><![CDATA[
            $this->data['entry_message'] = $this->language->get('entry_message'); ]]></search>
            <add><![CDATA[
			$this->data['entry_template'] = $this->language->get('entry_template');
            
			$this->load->model('module/emailtemplate');
            $this->data['templates'] = $this->model_module_emailtemplate->getTemplates(array('type' => 'newsletter'));            
            $this->data['templates_action'] = $this->url->link('module/emailtemplate/fetch_template', 'token='.$this->session->data['token'], 'SSL'); ]]></add>
        </operation>
        <operation info="Fetch all languages">
            <search position="before" index="1"><![CDATA[
            $emails = array(); ]]></search>
            <add><![CDATA[
            $this->load->model('setting/setting');
			$this->load->model('module/emailtemplate');
			$this->load->model('localisation/language');
            $languages = $this->model_localisation_language->getLanguages(); ]]></add>
        </operation>
        <operation info="Add extra info into email array, ensure affiliate is not effected">
            <search position="replace" index="1,2"><![CDATA[
            $emails[] = $result['email']; ]]></search>
            <add><![CDATA[
            $emails[$result['customer_id']] = array(
            	'email' => $result['email'],
            	'store_id' => $result['store_id'],
            	'customer_id' => $result['customer_id'],
            	'language_id' => $result['language_id']
           	); ]]></add>
        </operation>
        <operation info="Add extra info into email array">
            <search position="replace"><![CDATA[
            $emails[] = $customer_info['email']; ]]></search>
            <add><![CDATA[
            $emails[] = array(
            	'email' => $customer_info['email'],
            	'customer_id' => $customer_info['customer_id'],
            	'store_id' => $customer_info['store_id'],
            	'language_id' => $customer_info['language_id']
           	); ]]></add>
        </operation>
        <operation info="Add extra info into email array">
            <search position="replace"><![CDATA[
            $emails[$result['customer_id']] = $result['email']; ]]></search>
            <add><![CDATA[
            $emails[$result['customer_id']] = array(
            	'email' => $result['email'],
            	'customer_id' => $result['customer_id'],
            	'store_id' => $result['store_id'],
            	'language_id' => $result['language_id']
           	); ]]></add>
        </operation>
        <operation info="Add extra info into email array for: product">
            <search position="replace" index="4"><![CDATA[
            $emails[] = $result['email']; ]]></search>
            <add><![CDATA[
            $emails[] = array(
            	'email' => $result['email'],
            	'store_id' => $result['store_id'],
            	'customer_id' => $result['customer_id'],
            	'language_id' => $result['language_id']
           	); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            foreach ($emails as $email) { ]]></search>
            <add><![CDATA[
            if(!isset($email['customer_id'])) continue;
			$languageId = isset($email['language_id']) ? $email['language_id'] : $this->config->get('config_language_id');
            $template = new EmailTemplate($this->request, $this->registry, $languageId);
            $template->tracking('newsletter');
            			
			$store_settings_config = $this->model_setting_setting->getSetting("config", $email['store_id']);						
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $email['store_id']);			
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');
			
			$language = $this->language; // save current lang  
			foreach($languages as $lang){				
				if($lang['language_id'] == $languageId){
					$language = new Language($lang['directory']);
					$language->load("sale/contact");
				}
			} ]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[
            $mail->setFrom($this->config->get('config_email')); ]]></search>
            <add><![CDATA[
            $mail->setFrom($store_settings_config['config_email']); ]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[
            $mail->setTo($email);
            ]]></search>
            <add><![CDATA[
            $mail->setTo($email['email']); ]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[
            $mail->setHtml($message); ]]></search>
            <add><![CDATA[             
            if($template->getConfig('emailtemplate_unsubscribe') && in_array($this->request->post['to'], array('newsletter', 'customer_all', 'customer_group', 'customer'))) {
            	$url = (isset($store_info['url']) ? $store_info['url'] : HTTP_CATALOG) . 'index.php?route=account/newsletter/unsubscribe&code='.md5($email['email']);
            	$template->data['unsubscribe'] = sprintf(html_entity_decode($template->getConfig('emailtemplate_unsubscribe'), ENT_QUOTES, 'UTF-8'), $url);
            }
            
            $body = $this->model_module_emailtemplate->parseTemplate($this->request->post['message'], array_merge($email, $this->request->post));
			$html = $template->fetch(null, '_mail.tpl', $body);
			
			$mail->setText(trim(strip_tags($body)));			
			$mail->setHtml($html); ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            $mail->addAttachment($attachment['path'], $attachment['filename']); ]]></search>
            <add></add>
        </operation>        
	</file>
	
	<file name="admin/view/template/sale/contact.tpl">
        <operation error="skip">
            <search position="replace"><![CDATA[
			$('textarea[name=\'message\']').html($('textarea[name=\'message\']').val()); ]]></search>
            <add><![CDATA[
			$('textarea[name=\'message\']').html(CKEDITOR.instances['message'].getData()); ]]></add>
        </operation>
        <operation error="skip" indo="Missing from OC:1.5.1.3.1">
            <search position="before"><![CDATA[
            function send(url) { ]]></search>
            <add><![CDATA[
			(function($){			
				$(document).ready(function() {
				
					$('select#field_templates').change(function(){
						if (!confirm("Are you sure you want to change the template? This will clear all of the text inside the editor")) return;
						$.ajax({
				            url: '<?php echo html_entity_decode($templates_action); ?>',
				            type: 'post',
				            dataType: 'html',
				            data: 'id='+$(this).val() + '&store_id='+$('select[name=store_id]').val(),
				            success: function(html) {
				                 $('textarea[name=message]').val(html);  
				                 CKEDITOR.instances['message'].setData(html);  
				            },
				            error: function(xhr, ajaxOptions, thrownError) {
			                    console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			                    alert('Error. More details in console.');
				            }
				   		});	
					});
					
				});	
			})(jQuery); ]]></add>
        </operation>        
        <operation info="Add order summary option">
            <search position="after"><![CDATA[
            <td><input type="text" name="subject" value=" ]]></search>
            <add><![CDATA[
            <?php if(!empty($templates)){ ?>
          </tr>
          <tr>
            <td><?php echo $entry_template; ?></td>
            <td>
            	<select id="field_templates" name="email_template">
	            	<option></option>
	            	<?php foreach($templates as $_template){ ?>
	            		<option value="<?php echo $_template['id']; ?>"><?php echo $_template['name'].' - '.$_template['language_code']; ?></option>
	            	<?php } ?>
            	</select>
           	<?php } ?> ]]></add>
        </operation>
	</file>
		
	<file name="admin/model/sale/voucher.php">
        <operation>
            <search position="replace"><![CDATA[
            $template = new Template(); ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/voucher');
            
			// Overwrite config with store data
			$this->load->model('setting/setting');
			$this->load->model('setting/store');
			$store_info = $this->model_setting_store->getStore($order_info['store_id']);
			$store_settings_config = $this->model_setting_setting->getSetting("config", $order_info['store_id']);
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			
			// Overwrite config with email data
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $order_info['store_id']);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail'); ]]></add>
        </operation>
        <operation error="skip" info="OC:1.5.0.5">
            <search position="replace"><![CDATA[
            $template->data['image'] = 'cid:' . basename($voucher_theme_info['image']); ]]></search>
            <add><![CDATA[
            $template->data['image'] = HTTP_CATALOG . 'image/' . $voucher_theme_info['image']; ]]></add>
        </operation>
        <operation error="skip" info="OC:1.5.1.3">
            <search position="replace"><![CDATA[
            $template->data['image'] = 'cid:' . md5(basename($voucher_theme_info['image'])); ]]></search>
            <add><![CDATA[
            $template->data['image'] = HTTP_CATALOG . 'image/' . $voucher_theme_info['image']; ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            $mail->addAttachment(DIR_IMAGE . $voucher_theme_info['image'], md5(basename($voucher_theme_info['image']))); ]]></search>
            <add></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[
            $mail->setHtml($template->fetch('mail/voucher.tpl')); ]]></search>
            <add><![CDATA[
            list($width, $height) = getimagesize(DIR_IMAGE . $voucher_theme_info['image']);
           	$template->data['image_width'] = $width;
           	$template->data['image_height'] = $height;
           	
           	$message = $template->data['title'] . "\n\n" .
            		   $template->data['text_greeting']  . "\n\n" .
            		   $template->data['text_from']  . "\n\n" .
            		   $template->data['text_message']  . "\n" .
            		   $template->data['message']  . "\n\n" .
            		   $template->data['text_redeem']  . "\n\n" .
            		   $template->data['store_url']  . "\n\n" .
            		   $template->data['text_footer'];
            
           	$mail->setText(html_entity_decode(strip_tags($message), ENT_QUOTES, 'UTF-8'));
			$mail->setHtml($template->fetch('customer_voucher.tpl', '_mail.tpl')); ]]></add>
        </operation>
	</file>
		
	<file name="admin/model/sale/customer.php">
        <operation error="skip">
            <search position="replace"><![CDATA[
			$store_url = $store_info['url'] . 'index.php?route=account/login'; ]]></search>
            <add><![CDATA[
            $store_url = $store_info['url'];
			$account_login = $store_info['url'] . 'index.php?route=account/login'; ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
			$store_url = HTTP_CATALOG . 'index.php?route=account/login'; ]]></search>
            <add><![CDATA[
            $store_url = HTTP_CATALOG;
			$account_login = HTTP_CATALOG . 'index.php?route=account/login'; ]]></add>
        </operation>		
        <operation>
            <search position="replace"><![CDATA[
            $message .= $store_url . "\n\n"; ]]></search>
            <add><![CDATA[
           	$message .= $account_login . "\n\n"; ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            $message .= $store_name; ]]></search>
            <add><![CDATA[                        
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/customer/approve');
                        
            // Overwrite config with store data
			$this->load->model('setting/setting');
			$store_settings_config = $this->model_setting_setting->getSetting("config", $customer_info['store_id']);
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			
			// Overwrite config with email data
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $customer_info['store_id']);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');
			
			$template->appendDataLanguage($this->language, array(
            	'text_approve_login',
            	'text_approve_services',
            	'text_approve_thanks'
            ));
            
			$template->appendData(array(
				'account_login' => $account_login,
				'text_welcome' => sprintf($this->language->get('text_approve_welcome'), $store_name)
			));
													
			$html = $template->fetch('customer_approve.tpl', '_mail.tpl'); ]]></add>
        </operation>
		<operation>
            <search position="before"><![CDATA[
            $mail->send(); ]]></search>
            <add><![CDATA[
            $mail->setReplyTo($customer_info['email'], $customer_info['firstname'].' '.$customer_info['lastname']);
            $mail->setHTML($html); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            $message .= sprintf($this->language->get('text_transaction_total'), $this->currency->format($this->getTransactionTotal($customer_id))); ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/customer/transaction');
            
			// Overwrite config with store data
			$this->load->model('setting/setting');
			$this->load->model('setting/store');
			if(!isset($store_info)){
				$store_info = $this->model_setting_store->getStore($customer_info['store_id']);
			}
			$store_settings_config = $this->model_setting_setting->getSetting("config", $customer_info['store_id']);
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			
			// Overwrite config with email data
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $customer_info['store_id']);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');
			
			$template->appendData(array(
				'transaction_received' => sprintf($this->language->get('text_transaction_received'), $this->currency->format($amount, $this->config->get('config_currency'))),
				'transaction_total' => sprintf($this->language->get('text_transaction_total'), $this->currency->format($this->getTransactionTotal($customer_id)))
			));
												
			$html = $template->fetch('customer_transaction.tpl', '_mail.tpl'); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            $message .= sprintf($this->language->get('text_reward_total'), $this->getRewardTotal($customer_id)); ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/customer/reward');
            
			// Overwrite config with store data
			$this->load->model('setting/setting');
			$this->load->model('setting/store');
			
			if(isset($store_info)){
				$store_id = $order_info['store_id'];
			} else {
				$store_id = $customer_info['store_id'];
			}
			
			$store_info = $this->model_setting_store->getStore($store_id);			
			$store_settings_config = $this->model_setting_setting->getSetting("config", $customer_info['store_id']);
			
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			
			// Overwrite config with email data
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $customer_info['store_id']);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');
			
			$template->appendData(array(
				'reward_received' => sprintf($this->language->get('text_reward_received'), $points),
				'reward_total' => sprintf($this->language->get('text_reward_total'), $this->getRewardTotal($customer_id))
			));
						
			$html = $template->fetch('customer_reward.tpl', '_mail.tpl'); ]]></add>
        </operation>
	</file>
	
	<file name="admin/model/sale/return.php">
        <operation>
            <search position="after" index="1"><![CDATA[
            if ($return_query->num_rows) { ]]></search>
            <add><![CDATA[            
			$this->load->model('localisation/return_reason');
			$return_reason_info = $this->model_localisation_return_reason->getReturnReason($return_query->row['return_reason_id']); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            $message .= $this->language->get('text_footer'); ]]></search>
            <add><![CDATA[            
			$this->load->model('sale/order');
			$order_info = $this->model_sale_order->getOrder($return_query->row['order_id']);
			$store_id = $order_info['store_id'];
			
			// Overwrite config with store data
			$this->load->model('setting/setting');
			$this->load->model('setting/store');
			$store_info = $this->model_setting_store->getStore($store_id);			
			$store_settings_config = $this->model_setting_setting->getSetting("config", $store_id);
			
			$template = new EmailTemplate($this->request, $this->registry, $order_info['language_id']);
			$template->tracking('sale/return');
			
			$template->populateStoreData(array_merge($store_settings_config, $store_info));
			
			$et_store = $this->model_setting_setting->getSetting("emailtemplate", $store_id);
			$template->populateEmailData($et_store);
			
			$template->setThemeDir('mail');
			
			$template->appendDataLanguage($this->language, array(
            	'text_comment',
            	'text_date_added',
            	'text_footer',
            	'text_product',
            	'text_opened',
            	'text_model',
            	'text_quantity',
            	'text_return',
            	'text_return_id',
            	'text_return_status'
            ));
            
			$template->appendData(array(
				'return_id' => $return_id,
				'date_added'=> date($this->language->get('date_format_short'), strtotime($return_query->row['date_added'])),
				'status' 	=> $return_query->row['status'],
				'comment' 	=> (isset($data['comment'])) ? (strcmp($data['comment'], strip_tags($html_str = html_entity_decode($data['comment'], ENT_QUOTES, 'UTF-8'))) == 0) ? nl2br($data['comment']) : $html_str : '',
				'name' => $return_query->row['product'],
				'model' => $return_query->row['model'],
				'quantity' => $return_query->row['quantity'],
				'reason' => ($return_reason_info) ? $return_reason_info['name'] : '',
				'opened' => $return_query->row['opened'] ? $this->language->get('text_yes') : $this->language->get('text_no'),
				'show_summary' => isset($data['show_summary']) ? $data['show_summary'] : 0
			));
												
			$html = $template->fetch('return_history.tpl', '_mail.tpl'); ]]></add>
        </operation>
		<operation>
            <search position="before"><![CDATA[
            $mail->send(); ]]></search>
            <add><![CDATA[
            $mail->setHTML($html); ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            comment = '" . $this->db->escape(strip_tags($data['comment'])) . "' ]]></search>
            <add trim="true"><![CDATA[
            comment = '" . $this->db->escape($data['comment']) . "' ]]></add>
        </operation>
	</file>
	
	<file name="admin/controller/sale/return.php">
        <operation>
            <search position="after"><![CDATA[
            $this->data['entry_notify'] = $this->language->get('entry_notify'); ]]></search>
            <add><![CDATA[
            $this->data['entry_summary'] = $this->language->get('entry_summary');
            $this->data['entry_show_summary'] = $this->language->get('entry_show_summary'); ]]></add>
        </operation>
        <operation error="skip">
            <search position="replace"><![CDATA[
            nl2br($result['comment']) ]]></search>
            <add trim="true"><![CDATA[
            (strcmp($result['comment'], strip_tags($html_str = html_entity_decode($result['comment'], ENT_QUOTES, 'UTF-8'))) == 0) ? nl2br($result['comment']) : $html_str ]]></add>
        </operation>
    </file>
    
	<file name="admin/view/template/sale/return_info.tpl">
        <operation info="Add return summary option">
            <search position="after"><![CDATA[
            <td><input type="checkbox" name="notify" value="1" /></td> ]]></search>
            <add><![CDATA[
          </tr>
          <tr id="summaryRow" style="display: none">
            <td><?php echo $entry_summary; ?></td>
            <td>
           		<label><input type="checkbox" name="show_summary" value="1" style="vertical-align: middle;" /> <?php echo $entry_show_summary; ?></label><br /> ]]></add>
        </operation>
         <operation>
            <search position="after"><![CDATA[
            $('.vtabs a').tabs(); ]]></search>
            <add><![CDATA[//--></script> 			
            <script type="text/javascript" src="view/javascript/ckeditor/ckeditor.js"></script>
			<script type="text/javascript"><!--
			// Order history show/hide summary options
			(function($){
				function showSummaryRow($notify){
					var $summaryRow = $('#summaryRow');
					if($notify.is(':checked')) { 
						$summaryRow.show(); 
					} else { 
						$summaryRow.hide(); 
					}
				}				
				$(document).ready(function() {
					$('input[name=notify]').eq(0).each(function(){
						showSummaryRow($(this));
					}).change(function(){
						showSummaryRow($(this));
					});
				});	
			})(jQuery);		
			
			CKEDITOR.replace('comment', {
				filebrowserImageBrowseUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
				filebrowserUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
				filebrowserImageUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>'
			}); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
            function history() { ]]></search>
            <add><![CDATA[
            // Force CKEDITOR instance in the form to update their respective fields
            CKEDITOR.instances.comment.updateElement(); ]]></add>
        </operation>
        <operation error="skip">
            <search position="before"><![CDATA[
            $('textarea[name=\'comment\']').val(''); ]]></search>
            <add><![CDATA[
            // Clear CKEDITOR data
            CKEDITOR.instances.comment.setData(''); ]]></add>
        </operation>
        <operation info="Add checkboxes into ajax post data">
            <search position="replace"><![CDATA[
            + '&notify=' ]]></search>
            <add trim="true"><![CDATA[
            + '&show_summary=' + encodeURIComponent($('input[name=\'show_summary\']').attr('checked') ? 1 : 0) + '&notify=' ]]></add>
        </operation>
	</file>
	
	<file name="admin/model/sale/affiliate.php">
        <operation>
            <search position="before"><![CDATA[
            $message .= $this->config->get('config_name'); ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/affiliate/approve');
            $template->setThemeDir('mail');
			
			$template->appendDataLanguage($this->language, array(
            	'text_approve_login',
            	'text_approve_services',
            	'text_approve_thanks'
            ));
            
			$template->appendData(array(
				'text_welcome' => sprintf($this->language->get('text_approve_welcome'), $this->config->get('config_name')),
				'affiliate_login' => HTTP_CATALOG . 'index.php?route=affiliate/login'
			));
									
			$html = $template->fetch('affiliate_approve.tpl', '_mail.tpl'); ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
			$message .= sprintf($this->language->get('text_transaction_total'), $this->currency->format($this->getTransactionTotal($affiliate_id), $this->config->get('config_currency'))); ]]></search>
            <add><![CDATA[
            $template = new EmailTemplate($this->request, $this->registry);
            $template->tracking('sale/affiliate/transaction');
            $template->setThemeDir('mail');
			
			$template->appendData(array(
				'text_received' => sprintf($this->language->get('text_transaction_received'), $this->currency->format($amount, $this->config->get('config_currency'))),
				'text_total' => sprintf($this->language->get('text_transaction_total'), $this->currency->format($this->getTransactionTotal($affiliate_id), $this->config->get('config_currency')))
			));
									
			$html = $template->fetch('affiliate_transaction.tpl', '_mail.tpl'); ]]></add>
        </operation>
		<operation>
            <search position="before"><![CDATA[
            $mail->send(); ]]></search>
            <add><![CDATA[
            $mail->setHTML($html); ]]></add>
        </operation>
	</file>
		
</modification>
